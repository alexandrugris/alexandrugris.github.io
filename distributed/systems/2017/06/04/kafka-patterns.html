<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Apache Kafka</title>
  <meta name="description" content="Playing around with Apache Kafka. The article covers running a Kafka cluster on a development machine using a pre-made Docker image, playing around with the ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://alexandrugris.github.io/distributed/systems/2017/06/04/kafka-patterns.html">
  <link rel="alternate" type="application/rss+xml" title="From The Trenches - The Code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <div class="site-nav"><a class="site-title" href="/">From The Trenches - The Code</a> </div>

    <nav class="site-nav">
      <span class="menu-icon">        
      </span>

      <div class="trigger">

        <a class="page-link" href="https://alexandrugris.github.io">Home</a>

        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/sm/">Social Media</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Apache Kafka</h1>
    <p class="post-meta"><time datetime="2017-06-04T14:15:16+03:00" itemprop="datePublished">Jun 4, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Playing around with Apache Kafka. The article covers running a Kafka cluster on a development machine using a pre-made Docker image, playing around with the command line tools distributed with Apache Kafka and writing producers and consumers.</p>

<h3 id="how-to-run-apache-kafka">How to run Apache Kafka</h3>

<p>The simplest way: <code class="highlighter-rouge">docker-compose up</code> with the following <code class="highlighter-rouge">docker-compose.yml</code></p>

<div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="c1"># based on https://github.com/wurstmeister/kafka-docker</span>

<span class="s">services</span><span class="pi">:</span>
  <span class="s">zookeeper</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">wurstmeister/zookeeper</span>
    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">2181:2181"</span>

  <span class="s">kafka</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">wurstmeister/kafka</span>

    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9092:9092"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">1099:1099"</span> <span class="c1"># for JMX - not needed unless we want to monitor the service</span>

    <span class="s">environment</span><span class="pi">:</span>
      <span class="s">KAFKA_ADVERTISED_HOST_NAME</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
      <span class="s">KAFKA_ZOOKEEPER_CONNECT</span><span class="pi">:</span> <span class="s">zookeeper:2181</span>
      <span class="s">KAFKA_JMX_OPTS</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-Dcom.sun.management.jmxremote</span><span class="nv"> </span><span class="s">-Dcom.sun.management.jmxremote.authenticate=false</span><span class="nv"> </span><span class="s">-Dcom.sun.management.jmxremote.ssl=false</span><span class="nv"> </span><span class="s">-Djava.rmi.server.hostname=127.0.0.1</span><span class="nv"> </span><span class="s">-Dcom.sun.management.jmxremote.rmi.port=1099"</span>
      <span class="s">JMX_PORT</span><span class="pi">:</span> <span class="s">1099</span>

    <span class="s">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
</code></pre>
</div>

<p>Another option, if we want to scale the Kafka cluster is to run:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker-compose up -d
</code></pre>
</div>

<p>and then</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker-compose scale kafka=2
</code></pre>
</div>

<p>However, in order for this to run, we need to make some changes to our docker-compose file:</p>

<div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="c1"># based on https://github.com/wurstmeister/kafka-docker</span>

<span class="s">services</span><span class="pi">:</span>
  <span class="s">zookeeper</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">wurstmeister/zookeeper</span>
    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">2181"</span>

  <span class="s">kafka</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">wurstmeister/kafka</span>

    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9092"</span> <span class="c1"># we do not publish these ports anymore to host</span>
      
    <span class="s">environment</span><span class="pi">:</span>
      <span class="s">HOSTNAME_COMMAND</span><span class="pi">:</span> <span class="s2">"</span><span class="s">route</span><span class="nv"> </span><span class="s">-n</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">awk</span><span class="nv"> </span><span class="s">'/UG[</span><span class="nv"> </span><span class="se">\t</span><span class="s">]/{print</span><span class="nv"> </span><span class="s">$$2}'"</span>
      <span class="s">KAFKA_ZOOKEEPER_CONNECT</span><span class="pi">:</span> <span class="s">zookeeper:2181</span>
      <span class="c1"># we dropped completely the JMX part</span>

    <span class="s">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
</code></pre>
</div>

<p>In this docker image, Kafka is installed in <code class="highlighter-rouge">/opt/kafka</code>, thus running</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker exec testkafka_kafka_2 ls /opt/kafka/bin
</code></pre>
</div>

<p>will get get us the list of all Kafka binaries. Letâ€™s connect to one of the two Kafka instances.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker exec -it testkafka_kafka_2 bash
</code></pre>
</div>

<p><img src="https://alexandrugris.github.io/assets/kafka_1.png" alt="Kafka Connection" /></p>

<p>However, if JMX is still specified, the <code class="highlighter-rouge">JMX_PORT</code> is already set and in use by the Kafka daemon, so in order to run commands to Kafka we need to make a little hack:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$&gt;JMX_PORT=1100
$&gt;KAFKA_JMX_OPTS=""
</code></pre>
</div>

<p>Then we can play:</p>

<p><img src="https://alexandrugris.github.io/assets/kafka_2.png" alt="Kafka Commands" /></p>

<p>To produce messages to <code class="highlighter-rouge">my_topic</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bash-4.3# ./kafka-console-producer.sh --topic my_topic --broker-list testkafka_kafka_1:9092
</code></pre>
</div>

<p>To read messages from <code class="highlighter-rouge">my_topic</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bash-4.3# ./kafka-console-consumer.sh --topic my_topic --zookeeper zookeeper:2181 --from-beginning
</code></pre>
</div>

<h3 id="basic-concepts">Basic Concepts</h3>

<p>Apache Kafka is a high-throughput distributed pub-sub messaging system, with on-disk persistence. In essence, it can be viewed as a distributed immutable ordered (by time) sequence of messages. Each consumer has a private read-only cursor, which it can reset at any time. This way of storing messages / events makes Kafka appropriate as a distributed store for event sourcing architectural pattern.</p>

<p><em>Concepts:</em></p>

<ul>
  <li>A Kafka cluster is a grouping of multiple Kafka brokers (could be hundreds).</li>
  <li>Topics can span over a multitude of brokers.</li>
  <li>Each topic has one or more partitions.</li>
  <li>Each partition is maintained over one or more brokers.</li>
  <li>Each partition must fit on one machine.</li>
  <li>Each partition is mutually exclusive from each other. This means the same message wil never appear simultaneously on two partitions.</li>
  <li>If there is no partitioning scheme set up, messages are put to partitions in a round-robin fashion.</li>
  <li>Message order is guaranteed only on a per-partition basis.</li>
</ul>

<p><em>Partitioning trade-offs:</em></p>

<ul>
  <li>The more partitions the more load on Zookeeper. Since Zookeeper keeps its data in memory only, resources on the Zookeeper machine can become constrainted.</li>
  <li>There is no global order in a topic with several partitions.</li>
  <li>As each partition can only fit on a single machine. This imposes the limit to how much a single partition can grow.</li>
</ul>

<p><em>Fault tolerance:</em></p>

<ul>
  <li>Broker failure</li>
  <li>Disk failure</li>
  <li>Network failure</li>
</ul>

<p>Replication factor is set on a topic level, thus can vary from topic to topic but not from partition to partition.</p>

<p>When we connect to both docker instances that we started in our demo cluster, because we set for topic <code class="highlighter-rouge">my_topic</code> 2 partitions and replication factor 2, we see the same picture:</p>

<p><img src="https://alexandrugris.github.io/assets/kafka_3.png" alt="One topic, 2 partitions, replication factor 2" /></p>

<p>In the image above, <code class="highlighter-rouge">ISR</code> means in-sync replicas. If we decide to kill one docker container, we get:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bash-4.3# /opt/kafka/bin/kafka-topics.sh --describe my_topic --zookeeper zookeeper:2181
Topic:my_topic  PartitionCount:2        ReplicationFactor:2     Configs:
        Topic: my_topic Partition: 0    Leader: 1001    Replicas: 1002,1001     Isr: 1001
        Topic: my_topic Partition: 1    Leader: 1001    Replicas: 1001,1002     Isr: 1001
</code></pre>
</div>

<p>The cluster has readjusted itself. Leader for partition 0 has been assigned 1001 (instead of 1002 which was previously), we still have two replicas, but ISR is only 1001.</p>

<p>If we start the stopped container again, we get:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bash-4.3# /opt/kafka/bin/kafka-topics.sh --describe my_topic --zookeeper zookeeper:2181
Topic:my_topic  PartitionCount:2        ReplicationFactor:2     Configs:
        Topic: my_topic Partition: 0    Leader: 1001    Replicas: 1002,1001     Isr: 1001,1002
        Topic: my_topic Partition: 1    Leader: 1001    Replicas: 1001,1002     Isr: 1001,1002
</code></pre>
</div>

<p>Leader for both partitions stay the same, but this time ISR are both 1001 and 1002.</p>

<p><a href="https://www.quora.com/How-many-topics-can-be-created-in-Apache-Kafka/answer/Jay-Kreps?srid=55SS">How many topics can be created in Apache Kafka?</a></p>

<p><em>Retention policy:</em></p>

<p>Retention is regardless of whether any consumer has read any message. Default retention time is 7 days. Unlike RabbitMQ for instance, where TTL is set on a per-message basis, in Kafka retention policy is set on a per-topic basis.</p>

<h3 id="debugging-kafka-clients">Debugging Kafka Clients</h3>

<p>There are two basic ways to debug Kafka clients when you want to run everything on your machine. The simplest way is to run a single kafka instance and map its port to localhost. Thus, in the client application, there will be only one Kafka broker to connect to, that is to <code class="highlighter-rouge">localhost</code>.</p>

<p>However, there is another one, slightly more complex but more rewarding as one can scale as many brokers as he/she wishes. This requires the creation of another service in the docker compose file which runs the Java application to debug, because it is needed that this app runs in the same docker network as the rest of the cluster. It also requires remote debugging enabled and mapping of the project directory in a volume in the docker container that runs the app. Here is the updated <code class="highlighter-rouge">docker-compose.yml</code> as it is configured on my machine.</p>

<div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="c1"># based on https://github.com/wurstmeister/kafka-docker</span>

<span class="s">services</span><span class="pi">:</span>
  <span class="s">zookeeper</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">wurstmeister/zookeeper</span>
    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">2181"</span>

  <span class="s">kafka_client_app</span><span class="pi">:</span> <span class="c1"># the container to which my java client connects to</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">openjdk</span>

    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8000:8000"</span> <span class="c1"># expose the debugger port to localhost</span>

    <span class="s">depends_on</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">kafka</span>

    <span class="s">command</span><span class="pi">:</span> <span class="s">java -agentlib:jdwp=transport=dt_socket,server=y,address=8000,suspend=y -Dbootstrap.servers=kafka:9092 -cp /myapp/out/production/TestKafka:/myapp/lib/* ro.alexandrugris.BasicKafkaProducer</span> <span class="c1"># wait for debugger in suspend mode</span>

    <span class="s">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">C:\Users\alexa\IdeaProjects\TestKafka:/myapp</span> <span class="c1"># map the project to the container</span>

  <span class="s">kafka</span><span class="pi">:</span> <span class="c1"># for scale</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">wurstmeister/kafka</span>
    <span class="s">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">zookeeper</span>

    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9092"</span>

    <span class="s">environment</span><span class="pi">:</span>
      <span class="s">HOSTNAME_COMMAND</span><span class="pi">:</span> <span class="s2">"</span><span class="s">route</span><span class="nv"> </span><span class="s">-n</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">awk</span><span class="nv"> </span><span class="s">'/UG[</span><span class="nv"> </span><span class="se">\t</span><span class="s">]/{print</span><span class="nv"> </span><span class="s">$$2}'"</span>
      <span class="s">KAFKA_ZOOKEEPER_CONNECT</span><span class="pi">:</span> <span class="s">zookeeper:2181</span>

      <span class="c1"># create a topic on start</span>
      <span class="s">KAFKA_CREATE_TOPICS</span><span class="pi">:</span> <span class="s2">"</span><span class="s">alexandrugris.my_topic:5:2:compact"</span> <span class="c1"># 5 partitions, 2 replicas</span>

    <span class="s">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
</code></pre>
</div>

<p>And some screenshots:</p>

<p><em>Debugger Configuration in Idea</em></p>

<p><img src="https://alexandrugris.github.io/assets/kafka_4.png" alt="Debugger Config Idea" /></p>

<p><em>Breakpoint in remote debugging config</em>
<img src="https://alexandrugris.github.io/assets/kafka_5.png" alt="Debugger Breakpoint" /></p>

<p><em>Cluster up, with bash started on app node</em>
<img src="https://alexandrugris.github.io/assets/kafka_6.png" alt="Cluster" /></p>

<p><em>Produced messages in the queue</em>
<img src="https://alexandrugris.github.io/assets/kafka_7.png" alt="Messages" /></p>

<p><em>New topic created, ballanced, with 5 partitions and 2 replicas</em></p>

<p><img src="https://alexandrugris.github.io/assets/kafka_8.png" alt="Messages" /></p>

<h3 id="partitioning-and-producing-messages">Partitioning and producing messages</h3>

<p>Kafka has a simple yet powerful method for selecting to which partition the message is routed at the time of producing. The topic with its associated partitions is created either automatically when the producer is first run, like it is the case in our demo, or using the <code class="highlighter-rouge">kafka-topics.sh</code> tool. This behavior is configured through a setting in the <code class="highlighter-rouge">config.settings</code> file when the queue is started.</p>

<p>The algorithm for routing to partitions goes as follows:</p>

<ol>
  <li>If the partition is directly specifiedand it is a valid partition, then the message is routed directly to it.</li>
  <li>Else, if the key has been specified, then if a custom partitioner is present, specified at the creation of the Producer instance through <code class="highlighter-rouge">partitioner.class</code> property, then this custom partitioner is used.</li>
  <li>If the key has been specified but there is no custom partitioner instantiated, then the default paritioner will hash the key and will perform a modulo operation to assign the designated partition.</li>
</ol>

<p>The following snippet is the producer code initialized with a by-first-letter partitioner:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">BasicKafkaProducer</span><span class="o">(</span><span class="n">Properties</span> <span class="n">props</span><span class="o">){</span>
    <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"partitioner.class"</span><span class="o">,</span> <span class="s">"ro.alexandrugris.ByDestinationPartitioner"</span><span class="o">);</span>
    <span class="n">myProducer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaProducer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">MyMessage</span><span class="o">&gt;(</span>
            <span class="n">props</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">kafka</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">serialization</span><span class="o">.</span><span class="na">StringSerializer</span><span class="o">(),</span>
            <span class="k">new</span> <span class="n">ro</span><span class="o">.</span><span class="na">alexandrugris</span><span class="o">.</span><span class="na">ObjectSerializer</span><span class="o">&lt;</span><span class="n">MyMessage</span><span class="o">&gt;()</span>
            <span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">BasicKafkaProducer</span> <span class="n">me</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BasicKafkaProducer</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">()))</span> <span class="o">{</span>
        <span class="n">me</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"alexandru.gris"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"olga.muravska"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"olga.muravska"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"alexandru.gris"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"alexandru.gris"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"gris.laurian"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="s">"gris.laurian"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">)</span>
        <span class="o">));</span>
    <span class="o">}</span>
    <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">exx</span><span class="o">){</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exx</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">MyMessage</span><span class="o">&gt;</span> <span class="n">msgs</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">lock</span>      <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
    <span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">msgs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="kt">int</span> <span class="nf">decrement</span><span class="o">(){</span> <span class="k">return</span> <span class="o">--</span><span class="n">cnt</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span> 
    <span class="n">Counter</span> <span class="n">cnt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Counter</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="n">MyMessage</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">msgs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">myProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">MyMessage</span><span class="o">&gt;(</span><span class="n">TOPIC_NAME</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">destination</span><span class="o">(),</span> <span class="n">msg</span><span class="o">),</span> <span class="o">(</span><span class="n">RecordMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exception</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">metadata</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">cnt</span><span class="o">.</span><span class="na">decrement</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="n">lock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
                <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span> <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span> <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">exx</span><span class="o">){}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The producer is thread safe and should generally be shared among all threads for best performance. 
The producer manages a single background thread that does I/O as well as a TCP connection to each of the brokers it needs to communicate with. Failure to close the producer after use will leak these resources. Apache kafka is optimized for high throughput and, therefore, uses microbatching in its producer and consumer clients (<code class="highlighter-rouge">RecordAccumulator</code> low level class). For each topic-partition combination, internally a <code class="highlighter-rouge">RecordBatch</code> keeps track of these messages.</p>

<p><em>Batch options:</em></p>

<ul>
  <li><code class="highlighter-rouge">batch.size</code>: size of each <code class="highlighter-rouge">RecordBatch</code></li>
  <li><code class="highlighter-rouge">linger.ms</code>: how many milliseconds a buffer waits for new messages if not full</li>
  <li><code class="highlighter-rouge">batch.memory</code>: memory size for all <code class="highlighter-rouge">RecordBatches</code></li>
  <li><code class="highlighter-rouge">max.block.ms</code>: how many milliseconds the send method will be blocked for - used for creating back pressure on the producer to generate and send more messages to the buffer</li>
</ul>

<p>On return from send, the queue sends back a <code class="highlighter-rouge">RecordMetadata</code> with the result of the successfull or unsuccesfull transmission.</p>

<p><em>Delivery guarantees properties:</em></p>

<ul>
  <li><code class="highlighter-rouge">acks</code>: (0: fire and forget. 1: leader acknowledgement - only receives from the leader that the message has been stored, not from all the partitions. 2: quorum acknowledgement - all in sync replicas confirm the receipt )</li>
  <li><code class="highlighter-rouge">retries</code>: how many times the producer will retry sending the message</li>
  <li><code class="highlighter-rouge">retry.backoff.ms</code>: backoff time between each retry</li>
</ul>

<p>Message order is preserved only within a given partition. Retries and backoff destroy this quarantee. If we still want this guarantee enforced, we need to set <code class="highlighter-rouge">max.in.flight.request.per.connection=1</code>, but this dramatically affects performance.</p>

<p>All producer configuration options are defined as static strings in the <code class="highlighter-rouge">ProducerConfig</code> class.</p>

<p>The result of the per-first-letter partitioner when run:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$&gt;/opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server kafka:9092 --topic alexandrugris.my_topic --partition 0 --from-beginning
</code></pre>
</div>

<p><img src="https://alexandrugris.github.io/assets/kafka_9.png" alt="Messages" /></p>

<h3 id="consuming-messages">Consuming messages</h3>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">From The Trenches - The Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              From The Trenches - The Code
            
            </li>
            
            <li><a href="mailto:alexandru.gris2006@gmail.com">alexandru.gris2006@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/alexandrugris"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/alexandrugris"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Alexandru Gris - Personal Blog
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
