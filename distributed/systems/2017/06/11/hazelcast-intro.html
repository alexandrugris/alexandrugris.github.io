<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hazelcast Intro [WIP]</title>
  <meta name="description" content="A short introduction to Hazelcast: what it is, what scenarios is can be used for, how to run a test environment.">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://alexandrugris.github.io/distributed/systems/2017/06/11/hazelcast-intro.html">
  <link rel="alternate" type="application/rss+xml" title="From The Trenches - The Code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <div class="site-nav"><a class="site-title" href="/">From The Trenches - The Code</a> </div>

    <nav class="site-nav">
      <span class="menu-icon">        
      </span>

      <div class="trigger">

        <a class="page-link" href="https://alexandrugris.github.io">Home</a>

        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/sm/">Social Media</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Hazelcast Intro [WIP]</h1>
    <p class="post-meta"><time datetime="2017-06-11T14:15:16+03:00" itemprop="datePublished">Jun 11, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>A short introduction to Hazelcast: what it is, what scenarios is can be used for, how to run a test environment.</p>

<h2 id="what-is-hazelcast">What is Hazelcast</h2>

<p>Hazelcast is:</p>
<ul>
  <li>A distributed memory cache</li>
  <li>A clustering solution</li>
  <li>A no sql key/value datastore</li>
  <li>An in memory messaging system</li>
</ul>

<p>Hazelcast is an in-memory data grid, which allows to scale our applications dynamically, by simply adding new nodes to the cluster. On top of that, it has the ability to run embedded in our Java applications. There are two editions: the open source and the enterprise. The enterprise adds new security features, WAN replication (between clusters, possibily located in different datacentres) and Tomcat session clustering.</p>

<h2 id="first-application">First application</h2>

<p>Create a simple java console application, with Hazelcast library added to it:</p>

<p><img src="https://alexandrugris.github.io/assets/hazelcast_1.png" alt="Config" /></p>

<p>The server and the client share a very similar code, making applications symmetrical to write:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">ro</span><span class="o">.</span><span class="na">alexandrugris</span><span class="o">.</span><span class="na">javaplay</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.hazelcast.core.Hazelcast</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.hazelcast.core.HazelcastInstance</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HazelcastServerApp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">HazelcastInstance</span> <span class="nf">createStorageNode</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">Hazelcast</span><span class="o">.</span><span class="na">newHazelcastInstance</span><span class="o">();</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitForKey</span><span class="o">(){</span>
        <span class="k">try</span><span class="o">{</span>  <span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span> <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">exx</span><span class="o">){}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">HazelcastInstance</span> <span class="n">hi</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">createStorageNode</span><span class="o">();</span>
            <span class="n">waitForKey</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">hi</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">hi</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>


    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>For the client, the only difference is the <code class="highlighter-rouge">createStorageNode()</code> method, which still returns a <code class="highlighter-rouge">HazelcastInstance</code>, but has a different content:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">HazelcastInstance</span> <span class="nf">createStorageNode</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">HazelcastClient</span><span class="o">.</span><span class="na">newHazelcastClient</span><span class="o">();</span>
    <span class="o">};</span>
</code></pre>
</div>

<p>If we spanwn several instances of the server we notice that each of them joins the cluster automatically:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Members [3] {
	Member [192.168.1.6]:5701
	Member [192.168.1.6]:5702
	Member [192.168.1.6]:5703 this
}
</code></pre>
</div>

<p>If we kill one instance, the cluster will try a little bit to reconnect to it and then simply rebalance across the remaining nodes:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Members [2] {
	Member [192.168.1.6]:5701
	Member [192.168.1.6]:5702 this
}
</code></pre>
</div>

<p>The client will also automatically connect to the cluster but will not register itself as a member.</p>

<h2 id="the-distributed-map">The Distributed Map</h2>

<p>Data in Hazelcast is split in partititions and each partition is assigned to a node. By default, there are 271 partitions. Thus, there are more partitions on each node. Each node stores primary data and backup data.</p>

<p>The <code class="highlighter-rouge">IMap</code> interface inherits directly from <code class="highlighter-rouge">java.util.Map</code>. However, it is optimized for batch updates and thus, for performance reasons, it is preferred to put elements in a local <code class="highlighter-rouge">HashMap</code> and then use the <code class="highlighter-rouge">IMap::putAll</code> method to push all updates in a single operation. Therefore, while we can blindly use Hazelcast instead of a map anywhere in our application, the abstration leaks and it is better to be aware of the performance consequences. Each individual call is a Hazelcast transaction and requires a remote request / response. The <code class="highlighter-rouge">putAll</code> is also an atomic operation, but it includes all the elements of the map in a single transaction.</p>

<p>The following are synonims within the Hazelcast world: 1 Hazelcast instance == 1 storage node == 1 cluster member. If the Hazelcast servers are shutdown properly, they will rebalance the cluster to the extent of available memory. However, if they are killed, data is lost if all replicas are affected.</p>

<h3 id="types-stored-in-the-distributed-map-must-implement-serializable">Types stored in the distributed map must implement <code class="highlighter-rouge">Serializable</code></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>
<span class="c1">// must implement the Serializable inferface</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressBookEntry</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="c1">// https://stackoverflow.com/questions/285793/what-is-a-serialversionuid-and-why-should-i-use-it</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">8162873687563536545L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">MAP_NAME</span> <span class="o">=</span> <span class="s">"AddressBook_Map"</span><span class="o">;</span>

    <span class="c1">// fields</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">emailAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">streetAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AddressBookEntry</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">emailAddress</span><span class="o">,</span> <span class="n">String</span> <span class="n">streetAddress</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">emailAddress</span> <span class="o">=</span> <span class="n">emailAddress</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">streetAddress</span> <span class="o">=</span> <span class="n">streetAddress</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="adding-items-to-hazelcast-and-basic-querying">Adding items to Hazelcast and basic querying</h3>

<p>In the snippet below I add a batch of data to Hazelcast and then perform two basic queries:</p>
<ul>
  <li>Get the keys of the elements</li>
  <li>Get a list of elements based on a criteria different from the primary key</li>
</ul>

<p>We can add additional indexing on the fields that do not make up primary keys so that queries will run faster. For each <code class="highlighter-rouge">put</code> though, additional overhead will incur. Indexing on non-keys is not mandatory for queries, but can speed up processing for frequent operations.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>
    <span class="c1">// IMap implements the java.util.Map inferface</span>
    <span class="kd">static</span> <span class="n">IMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AddressBookEntry</span><span class="o">&gt;</span> <span class="n">addressBook</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addTestData</span><span class="o">(</span><span class="n">IMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AddressBookEntry</span><span class="o">&gt;</span> <span class="n">addressBook</span><span class="o">){</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AddressBookEntry</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">AddressBookEntry</span><span class="o">(</span><span class="s">"AG"</span><span class="o">,</span> <span class="s">"a@a.ro"</span><span class="o">,</span> <span class="s">"Otopeni"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">AddressBookEntry</span><span class="o">(</span><span class="s">"OM"</span><span class="o">,</span> <span class="s">"o@o.ro"</span><span class="o">,</span> <span class="s">"Otopeni"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">AddressBookEntry</span><span class="o">(</span><span class="s">"GL"</span><span class="o">,</span> <span class="s">"g@g.ro"</span><span class="o">,</span> <span class="s">"Otopeni"</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">AddressBookEntry</span><span class="o">(</span><span class="s">"GA"</span><span class="o">,</span> <span class="s">"a@a.ro"</span><span class="o">,</span> <span class="s">"Otopeni"</span><span class="o">)</span>
        <span class="o">).</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="nl">AddressBookEntry:</span><span class="o">:</span><span class="n">getKey</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">));</span>

        <span class="c1">// adding a map in one shot is more efficient, </span>
        <span class="c1">// as each 'put' call is treated as a separate transaction</span>
        <span class="n">addressBook</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">map</span><span class="o">);</span> 
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">HazelcastInstance</span> <span class="n">hi</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">bClient</span><span class="o">){</span>
        <span class="k">assert</span><span class="o">(</span><span class="n">hi</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// get the map and make operations on it</span>
        <span class="n">addressBook</span> <span class="o">=</span> <span class="n">hi</span><span class="o">.</span><span class="na">getMap</span><span class="o">(</span><span class="n">AddressBookEntry</span><span class="o">.</span><span class="na">MAP_NAME</span><span class="o">);</span>

        <span class="cm">/*

        // because later we will do a query based on the email address, 
        // let's add an index to it (this step is not mandatory)
        // "true" below means it allows range queries by
        // using a tree instead of a hashmap for the index

        addressBook.addIndex("emailAddress", true);

        */</span>
        
        <span class="k">if</span><span class="o">(</span><span class="n">addressBook</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span> 
            <span class="n">addTestData</span><span class="o">(</span><span class="n">addressBook</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="c1">// TEST 1: output the keys</span>
        <span class="n">addressBook</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">k</span><span class="o">));</span>

        <span class="c1">// TEST 2: use predicates to query the data on something else beside the primary key</span>
        <span class="c1">// emailAddress is a field in our class</span>
        <span class="n">addressBook</span><span class="o">.</span><span class="na">values</span><span class="o">(</span><span class="n">Predicates</span><span class="o">.</span><span class="na">or</span><span class="o">(</span>
                    <span class="c1">// emailAddress is a field (or getter) in AddressBookEntry</span>
                    <span class="n">Predicates</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="s">"emailAddress"</span><span class="o">,</span> <span class="s">"a@a.ro"</span><span class="o">),</span> 
                    <span class="n">Predicates</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="s">"emailAddress"</span><span class="o">,</span> <span class="s">"o@o.ro"</span><span class="o">))</span> 
            <span class="o">).</span><span class="na">stream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="na">emailAddress</span><span class="o">));</span>

        
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="adding-persistant-storage-capabilities">Adding persistant storage capabilities</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// persistence to a database</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">MapConfig</span> <span class="nf">getMapConfig</span><span class="o">(){</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">MapConfig</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setMapStoreConfig</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">MapStoreConfig</span><span class="o">()</span>
                                <span class="c1">// set the class which will implement the MapStore&lt;K, V&gt; interface</span>
                                <span class="o">.</span><span class="na">setImplementation</span><span class="o">(</span><span class="n">AddressBookMapStore</span><span class="o">.</span><span class="na">mapStore</span><span class="o">)</span>

                                <span class="c1">// write with a delay of 5 seconds, so the entries are batched</span>
                                <span class="o">.</span><span class="na">setWriteDelaySeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> 
                <span class="o">)</span>

                <span class="c1">// which map this configuration is for (name of the map)</span>
                <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">MAP_NAME</span><span class="o">);</span>

    <span class="o">}</span>
</code></pre>
</div>

<p>The function above is called through the following snippet, ran only on the storage nodes:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code> <span class="k">if</span><span class="o">(!</span><span class="n">bClient</span><span class="o">)</span> <span class="c1">// configure the map to use persistence if on the server</span>
    <span class="n">hazelcastInstance</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">addMapConfig</span><span class="o">(</span><span class="n">AddressBookEntry</span><span class="o">.</span><span class="na">getMapConfig</span><span class="o">());</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">AddressBookMapStore</code> is a straight forward implementation of the <code class="highlighter-rouge">MapStore&lt;K, V&gt;</code> interface:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code> <span class="c1">// implementation of persistence</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AddressBookMapStore</span> <span class="kd">implements</span> <span class="n">MapStore</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AddressBookEntry</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="n">AddressBookMapStore</span> <span class="n">mapStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddressBookMapStore</span><span class="o">();</span>
        <span class="kd">private</span> <span class="nf">AddressBookMapStore</span><span class="o">(){}</span>


        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">store</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">AddressBookEntry</span> <span class="n">addressBookEntry</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeAll</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AddressBookEntry</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">AddressBookEntry</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AddressBookEntry</span><span class="o">&gt;</span> <span class="nf">loadAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">loadAllKeys</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// TODO: persist here</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="indexing">Indexing</h3>

<p>If we want to add indexing on a different field except the primary key, a better way than described above in the basic querying section is to modify the MapConfig as follows:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">MapConfig</span> <span class="nf">getMapConfig</span><span class="o">(){</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">MapConfig</span><span class="o">()</span>

                <span class="cm">/* // Persistence to an external service (database)
                .setMapStoreConfig(
                        new MapStoreConfig()
                                .setImplementation(AddressBookMapStore.mapStore)
                                .setWriteDelaySeconds(3) 
                )
                */</span>

                <span class="c1">// Indexing:</span>
                <span class="o">.</span><span class="na">addMapIndexConfig</span><span class="o">(</span><span class="k">new</span> <span class="n">MapIndexConfig</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">setOrdered</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"emailAddress"</span><span class="o">))</span>

                <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">MAP_NAME</span><span class="o">);</span>
    <span class="o">}</span>

</code></pre>
</div>

<p>Link to docs <a href="http://docs.hazelcast.org/docs/3.3-EA2/manual/html-single/hazelcast-documentation.html#indexing">here</a>.</p>

<h3 id="concurrency-with-locks">Concurrency with locks</h3>

<p>Works, but it is not the fastest:</p>
<ul>
  <li>Creates synchronization points</li>
  <li>Forces two serialization operations over the network: <code class="highlighter-rouge">map.get(key)</code> and <code class="highlighter-rouge">map.put(key)</code>, even when we aim to update only a small part of the data.</li>
  <li>A better way is to use entry processors (next chapter)</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span>  <span class="kt">boolean</span> <span class="nf">updateWithLock</span><span class="o">(</span><span class="n">IMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="n">K</span> <span class="n">k</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">V</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">func</span><span class="o">){</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">map</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">func</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">k</span><span class="o">)));</span>

            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>

        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="n">map</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>    
</code></pre>
</div>

<h3 id="entry-processors">Entry processors</h3>

<p>Data is updated directly in the storage node. Especially for small updates, it reduces the amount of serialized data that is transmitted across the network. Entry processors are thread safe because are executed in Hazelcast in a serial manner per key, thus avoiding synchronization in client code. Hazelcast achieves this by keeping a list of entry processors per key on the storage node and executing them one after the other.</p>

<p>A great link to an <a href="https://wimdeblauwe.wordpress.com/2015/09/29/entryprocessors-and-entrybackupprocessors-with-hazelcast/">article explaining the <code class="highlighter-rouge">EntryProcessor</code> and <code class="highlighter-rouge">BackupEntryProcessor</code></a></p>

<p><code class="highlighter-rouge">AbstractEntryProcessor</code> updates both the master key and the backup key. If we just want to read a key with no locking or update only on the master copy,
we can implement <code class="highlighter-rouge">EntryProcessor</code> directly (no need to read the backup) or simply pass <code class="highlighter-rouge">false</code> to the constructror of <code class="highlighter-rouge">AbstractEntryProcessor</code>.</p>

<p>The method <code class="highlighter-rouge">EntryProcessor::process</code> returns an <code class="highlighter-rouge">Object</code> to the caller. This can be the anything, thus <code class="highlighter-rouge">EntryProcessors</code> can be used to read data without need to modify it.</p>

<p>The method <code class="highlighter-rouge">Map.Entry::setValue</code> must be called for the updated value to be persisted in Hazelcast.</p>

<p>Below is the code:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">interface</span> <span class="nc">SerializedConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">Serializable</span><span class="o">{</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">updateWithEntryProcessor</span><span class="o">(</span><span class="n">IMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="n">K</span> <span class="n">k</span><span class="o">,</span> <span class="n">SerializedConsumer</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">func</span><span class="o">){</span>

        <span class="n">EntryProcessor</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">ep</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AbstractEntryProcessor</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// true: applyOnBackup</span>
            <span class="nd">@Override</span>
            <span class="c1">// because we have the same EntryProcessor and BackupEntryProcessor functions, </span>
            <span class="c1">// this method will be invoked on each replica</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">process</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>

                <span class="n">V</span> <span class="n">addrBookEntry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span> <span class="c1">// does a local (on-node) serialization</span>

                <span class="k">if</span><span class="o">(</span><span class="n">addrBookEntry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="n">func</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">addrBookEntry</span><span class="o">);</span>
                    <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">addrBookEntry</span><span class="o">);</span> <span class="c1">// must set, or the value will not be stored!</span>

                    <span class="c1">// success, but can be anything -&gt; </span>
                    <span class="c1">//this value will be serialized and returned to the client</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> 
                <span class="o">}</span>

                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="k">return</span> <span class="o">(</span><span class="kt">boolean</span><span class="o">)</span><span class="n">map</span><span class="o">.</span><span class="na">executeOnKey</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">ep</span><span class="o">);</span> <span class="c1">// can be used with several keys</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>Invoked as:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code> <span class="k">if</span><span class="o">(!</span><span class="n">updateWithEntryProcessor</span><span class="o">(</span><span class="n">addressBook</span><span class="o">,</span> <span class="s">"OM"</span><span class="o">,</span>  <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">.</span><span class="na">emailAddress</span> <span class="o">=</span> <span class="s">"om@om.ro"</span><span class="o">)){</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Could not modify with EntryProcessor"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<p>As said before, the invocation happens on the client, while the breakpoint set in <code class="highlighter-rouge">EntryProcessor::process</code> is hit on the storage node:</p>

<p><em>Client Node</em></p>

<p><img src="https://alexandrugris.github.io/assets/hazelcast_2.png" alt="Config" /></p>

<p><em>Storage Node</em></p>

<p><img src="https://alexandrugris.github.io/assets/hazelcast_3.png" alt="Config" /></p>

<p>I am using here the <code class="highlighter-rouge">IMap::executeOnKey</code> method to run the <code class="highlighter-rouge">EntryProcessor</code> on a specific key. However, there are other useful methods to run <code class="highlighter-rouge">EP's</code>:</p>
<ul>
  <li><code class="highlighter-rouge">IMap::executeOnEntries</code> which has an optional <code class="highlighter-rouge">Predicate</code> parameter to select the desired keys</li>
  <li><code class="highlighter-rouge">IMap::executeOnKeys</code> to run the predicate against a specific set of keys</li>
</ul>

<p>An important point on accessing data from other structures in Hazelcast: <a href="https://stackoverflow.com/questions/30898557/accessing-imap-from-entryprocessor">https://stackoverflow.com/questions/30898557/accessing-imap-from-entryprocessor</a></p>

<h3 id="aggregators">Aggregators</h3>

<p>Aggregators are applied over the whole map and are run on the storage node. There are two functions needed for aggregation:</p>
<ul>
  <li>Getting the aggregated-by value from the <code class="highlighter-rouge">Map.Entry</code> -&gt; must extend the <code class="highlighter-rouge">Supplier&lt;Key, Value, Result&gt;</code> class</li>
  <li>Summarizing by that value and returning a single result -&gt; must extend the <code class="highlighter-rouge">Aggregation&lt;Key, SupplierResult, AggregationResult&gt;</code> class</li>
</ul>

<p>Here is an example usage:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SupplierFunc</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">{</span>
        <span class="n">R</span> <span class="nf">apply</span><span class="o">(</span><span class="n">K</span> <span class="n">k</span><span class="o">,</span> <span class="n">V</span> <span class="n">v</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">processAllEntriesWithAggregators</span><span class="o">(</span><span class="n">IMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span>
                                                               <span class="n">SupplierFunc</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">func</span><span class="o">,</span>
                                                               <span class="n">Aggregation</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">R</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">aggregation</span><span class="o">){</span>

        <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="k">new</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">R</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="n">aggregation</span><span class="o">);</span>

    <span class="o">}</span>
</code></pre>
</div>

<p>being called as:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// a basic aggregator which counts all letters from the email address (dummy, just for tests)</span>
<span class="kt">long</span> <span class="n">countOfAllLettersInEmailAddresses</span> <span class="o">=</span>

    <span class="n">processAllEntriesWithAggregators</span><span class="o">(</span>
        <span class="n">addressBook</span><span class="o">,</span> 
        <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)-&gt;</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">emailAddress</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)?</span> <span class="kc">null</span> <span class="o">:</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span><span class="n">v</span><span class="o">.</span><span class="na">emailAddress</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> 
        <span class="n">Aggregations</span><span class="o">.</span><span class="na">longSum</span><span class="o">());</span>

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All email addresses added letters amount to: "</span> <span class="o">+</span> <span class="n">countOfAllLettersInEmailAddresses</span><span class="o">);</span>
</code></pre>
</div>

<p>We used here:</p>
<ul>
  <li>A supplier in the form of a lambda expression - must implement a <code class="highlighter-rouge">Serializable</code> functional interface</li>
  <li>A provided aggregator: <code class="highlighter-rouge">Aggregations.longSum()</code></li>
</ul>

<p>If in the supplier we want to exclude an item (like is the case above for where <code class="highlighter-rouge">emailAddress == null</code>), we simply return <code class="highlighter-rouge">null</code> from the <code class="highlighter-rouge">Supplier::apply</code> function.</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">From The Trenches - The Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              From The Trenches - The Code
            
            </li>
            
            <li><a href="mailto:alexandru.gris2006@gmail.com">alexandru.gris2006@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/alexandrugris"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/alexandrugris"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Alexandru Gris - Personal Blog
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
