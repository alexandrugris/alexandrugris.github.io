<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Timeseries Analysis with PyTorch</title>
  <meta name="description" content="PyTorch is a widely used machine learning library, has an beautiful pythonic syntax and, above all, runs extremely fast on my M1 MacBook with no hacking requ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://alexandrugris.github.io/machine/learning/2022/05/19/timeseries-pytorch.html">
  <link rel="alternate" type="application/rss+xml" title="From The Trenches - The Code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <div class="site-nav"><a class="site-title" href="/">From The Trenches - The Code</a> </div>

    <nav class="site-nav">
      <span class="menu-icon">        
      </span>

      <div class="trigger">

        <a class="page-link" href="https://alexandrugris.github.io">Home</a>

        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/sm/">Social Media</a>
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Timeseries Analysis with PyTorch</h1>
    <p class="post-meta"><time datetime="2022-05-19T09:15:16+02:00" itemprop="datePublished">May 19, 2022</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>PyTorch is a widely used machine learning library, has an beautiful pythonic syntax and, above all, runs extremely fast on my M1 MacBook with no hacking required to make it run. I write this post following the steps I made to learn the library, by roughly translating the <a href="https://www.tensorflow.org/tutorials/structured_data/time_series">Time series forecasting with TensorFlow</a> tutorial to PyTorch, while making changes to it along the line to satisfy my curiosity.</p>

<h3 id="hello-world">Hello World</h3>

<p>Before starting, letâ€™s make sure we have the right libraries installed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$pip install torch matplotlib numpy pandas torchvision torchaudio
</code></pre></div></div>

<p>Then, import the right libraries and select a device for running accelerated PyTorch code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch</span> 
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

<span class="n">device</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">"cuda"</span>
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span>
    <span class="k">else</span> <span class="s">"mps"</span>
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span>
    <span class="k">else</span> <span class="s">"cpu"</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<p>In my case, the device will be <code class="language-plaintext highlighter-rouge">mps</code>, as I am running this on a MacBook Pro M1 Max.</p>

<h3 id="loading-and-processing-the-data">Loading and processing the data</h3>

<p>For this example I will use the <a href="https://www.kaggle.com/datasets/mnassrib/jena-climate">Jena Climate dataset</a> and the goal will be to predict the temperature (Celsius) over the future 1 or more hours. We are going to use 4 different approaches, a basic linear regression, a simple neural network, a convolutional neural network and, then, a recurrent neural network. They all give pretty good results and we will discuss the differences throughout the post.</p>

<p>Unlike in the TensorFlow tutorial on which this code is based, I will remove the temperature-related features from the training data and only keep them in the target variable. As such, we make the work of the ML models a bit harder.</p>

<p>The first step is loading the data and separating the <code class="language-plaintext highlighter-rouge">date_time</code> variable. We will process the <code class="language-plaintext highlighter-rouge">date_time</code> a bit later to include it back in the trianing set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># df contains hourly data
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"jena_climate_2009_2016.csv"</span><span class="p">)[</span><span class="mi">5</span><span class="p">::</span><span class="mi">6</span><span class="p">]</span>
<span class="n">date_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'Date Time'</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s">'%d.%m.%Y %H:%M:%S'</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch1.jpg" alt="Results" /></p>

<p>Next, we are going to do a bit of data cleanup and transform some of the variables:</p>
<ul>
  <li>Ensure there is no windspeed lower than 0</li>
  <li>Convert wind direction from degrees to vectors (maintaining magnitude)</li>
  <li>Standardize all numeric features for better processing by the neural networks</li>
  <li>Validate the periodicity of the time signal and transform from <code class="language-plaintext highlighter-rouge">date_time</code> to continuous variables that can be used in training.</li>
</ul>

<p>One by one, in the order specified above.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'wv (m/s)'</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s">'wv (m/s)'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df</span><span class="p">[</span><span class="s">'max. wv (m/s)'</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s">'max. wv (m/s)'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df</span><span class="p">.</span><span class="n">describe</span><span class="p">().</span><span class="n">transpose</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch2.jpg" alt="Highlighted the wind speed and direction" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># convert the wind degrees and wind speed to a wind vector
</span><span class="n">wv</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'wv (m/s)'</span><span class="p">)</span>
<span class="n">max_wv</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'max. wv (m/s)'</span><span class="p">)</span>

<span class="c1"># Convert to radians.
</span><span class="n">wd_rad</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'wd (deg)'</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

<span class="c1"># Calculate the wind x and y components.
</span><span class="n">df</span><span class="p">[</span><span class="s">'Wx'</span><span class="p">]</span> <span class="o">=</span> <span class="n">wv</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'Wy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">wv</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>

<span class="c1"># Calculate the max wind x and y components.
</span><span class="n">df</span><span class="p">[</span><span class="s">'max Wx'</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_wv</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'max Wy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_wv</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>

<span class="c1"># show wind vectors looking great
</span><span class="n">plt</span><span class="p">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Wx'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s">'Wy'</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Wind X [m/s]'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Wind Y [m/s]'</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'tight'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch3.jpg" alt="Wind as vector with direction and magnitude" /></p>

<p>Nothing fancy so far, just similar procesing as in the <a href="https://www.tensorflow.org/tutorials/structured_data/time_series">TensorFlow tutorial</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># standardize all numeric features
</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">-</span><span class="n">df</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">df</span><span class="p">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">"T (degC)"</span><span class="p">].</span><span class="n">plot</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s">"p (mbar)"</span><span class="p">].</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div></div>

<p>The following snippet of code is slightly more intersting. While in this case our intuition tells us that we have yearly and daily periodicity, the safest way to approach the problem of timeseries is to validate. We are going to analyse the spectrum of the signal and confirm our intuition. Comments inline, in the code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># check for seasonality
</span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># confirm the data is sampled hourly
</span><span class="k">print</span><span class="p">(</span><span class="n">date_time</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>

<span class="c1"># compute the fast fourier transform of the temperature
</span><span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">"T (degC)"</span><span class="p">])</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">fft</span><span class="p">.</span><span class="n">fft</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="c1"># length
</span><span class="n">T</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># sample frequency, 1/hour
</span><span class="n">D</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">T</span> <span class="c1"># duration
# the following line computes the actual frequencies in the spectrum
</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">fft</span><span class="p">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># we are interested only in the first half of the array
# the second half is filled with the conjugates for the first half
</span><span class="n">fft</span> <span class="o">=</span> <span class="n">fft</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>

<span class="c1"># take the highest 10 frequencies and compute their amplitude
</span><span class="nb">max</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">).</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>

<span class="c1"># compute the lengh of the period (1/freq) an the magnitudes
</span><span class="n">periods</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">frequency</span><span class="p">[</span><span class="nb">max</span><span class="p">])</span> <span class="o">/</span> <span class="mi">24</span> <span class="c1"># 24 == convert from hours to days
</span><span class="n">magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">[</span><span class="nb">max</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">N</span>

<span class="c1"># sampling is not perfect, hence some of the frequencies may fall in 
# two different buckets: e.g. 0.99h and 1.01h
</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mf">0.1</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">],</span> <span class="n">magnitudes</span><span class="p">):</span>
    <span class="n">cnt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span>

<span class="c1"># plot the frequencies and their magnitude
</span><span class="n">plt</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">cnt</span><span class="p">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">cnt</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>

<span class="c1"># we see clearly there is a yearly fundamental and a daily fundamental 
# (2920 days == 8 years - the number of years we have data for)
</span></code></pre></div></div>

<p>Periods in days - outstanding at 365 days and 1 day, as expected:</p>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch4.jpg" alt="Periods in days - outsanding at 365 days and 1 day" /></p>

<p>Given the information above, we can safely encode time as <code class="language-plaintext highlighter-rouge">sin</code> and <code class="language-plaintext highlighter-rouge">cos</code> for two different periods - yearly and daily. We are using both <code class="language-plaintext highlighter-rouge">sin</code> and <code class="language-plaintext highlighter-rouge">cos</code> in order to not confuse the algorithm as each <code class="language-plaintext highlighter-rouge">sin</code> and <code class="language-plaintext highlighter-rouge">cos</code> cross the 0 axis twice, having twice the same values over a period.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">timestamp_s</span> <span class="o">=</span> <span class="n">date_time</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span>

<span class="n">day</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
<span class="n">year</span> <span class="o">=</span> <span class="p">(</span><span class="mf">365.2425</span><span class="p">)</span><span class="o">*</span><span class="n">day</span> <span class="c1"># a bit of correction
</span>
<span class="c1"># normalized already
</span><span class="n">df</span><span class="p">[</span><span class="s">'Day sin'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">day</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">df</span><span class="p">[</span><span class="s">'Day cos'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">day</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">df</span><span class="p">[</span><span class="s">'Year sin'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">year</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">df</span><span class="p">[</span><span class="s">'Year cos'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">year</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
</code></pre></div></div>

<h3 id="generating-the-datasets">Generating the datasets</h3>

<p>After ensuring we have clean data, we are going to generate 3 data splits: training, validation and test.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># timeseries, so no random split
</span><span class="n">train_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.7</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
<span class="n">val_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.7</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="p">:</span> <span class="p">]</span>
</code></pre></div></div>

<p>In PyTorch, data is fed to the training loop through a <code class="language-plaintext highlighter-rouge">DataLoader</code> object. It handles batching and shuffling, and wraps a user-defined <code class="language-plaintext highlighter-rouge">Dataset</code>. The <code class="language-plaintext highlighter-rouge">Dataset</code> object needs to implement the standard <code class="language-plaintext highlighter-rouge">__len__</code> and <code class="language-plaintext highlighter-rouge">__getitem__</code> functions, so it behaves like an array.</p>

<p>For our code, we will implement a custom <code class="language-plaintext highlighter-rouge">Dataset</code> which wraps a <code class="language-plaintext highlighter-rouge">Pandas</code> dataframe and returns a specified number of time points as features and another number of time points as targets. In addition, it will have plotting functions for easier debugging and vizualization.</p>

<p>The parameters for the <code class="language-plaintext highlighter-rouge">Dataset</code> construction are as follows:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">df</code> - the Pandas dataframe to wrap</li>
  <li><code class="language-plaintext highlighter-rouge">input_window_len</code> - how many past points of time (hours in our case) to return as features</li>
  <li><code class="language-plaintext highlighter-rouge">target_len</code> - how many points in the future to return as target, for one-shot predictions</li>
  <li><code class="language-plaintext highlighter-rouge">shift</code> - when moving through the dataset, by how many datapoints to advance the cursor,</li>
  <li><code class="language-plaintext highlighter-rouge">var_columns</code> - which columns to include in the features</li>
  <li><code class="language-plaintext highlighter-rouge">target_columns</code> - which columns to include in the target</li>
  <li><code class="language-plaintext highlighter-rouge">transform</code> and <code class="language-plaintext highlighter-rouge">target_transform</code> - how to transform the resulting data, in our case it will be transformed to a <code class="language-plaintext highlighter-rouge">torch.Tensor</code> and dispatched to the GPU.</li>
</ul>

<p>One thing to note is to never-ever use Pandas in the training loop as it will slowdown training by at least 100x. Only use numpy arrays and do the conversion outside of the <code class="language-plaintext highlighter-rouge">__getitem__</code> function. We do this update in the <code class="language-plaintext highlighter-rouge">preprocess</code> method of the class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WindowedDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span>  
                        <span class="n">input_window_len</span><span class="p">,</span> 
                        <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">v</span>
                        <span class="n">ar_columns</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> 
                        <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                        <span class="n">target_transform</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="o">=</span> <span class="n">input_window_len</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_len</span> <span class="o">=</span> <span class="n">target_len</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_transform</span> <span class="o">=</span> <span class="n">target_transform</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_columns</span> <span class="o">=</span> <span class="n">target_columns</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span> <span class="o">=</span> <span class="n">var_columns</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">precompute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_input_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_columns</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">count_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_len</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">precompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">variables_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">target_columns</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">variables_</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_len</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_transform</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_transform</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">variables</span><span class="p">,</span> <span class="n">target</span>
    
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s">'__iter__'</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">var_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span>
            <span class="n">target_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_columns</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">precompute</span><span class="p">()</span>

            <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_len</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_len</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span><span class="p">)</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">v_</span><span class="p">,</span> <span class="n">t_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">shift</span>
                <span class="n">v</span> <span class="p">[</span><span class="n">ii</span> <span class="p">:</span> <span class="n">ii</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v_</span> 
                <span class="n">t</span> <span class="p">[</span><span class="n">ii</span> <span class="p">:</span> <span class="n">ii</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t_</span>

            <span class="n">axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)],</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">input_window_len</span> <span class="p">:</span> <span class="n">cnt</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">axis</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">cnt</span>
        
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">var_columns</span> <span class="o">=</span> <span class="n">var_tmp</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_columns</span> <span class="o">=</span> <span class="n">target_tmp</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">precompute</span><span class="p">()</span>

    
    <span class="k">def</span> <span class="nf">plot_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s">'__iter__'</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">axis</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># slow way to infer
</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># add batch dimension
</span>                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">).</span><span class="n">item</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s">"__iter__"</span><span class="p">):</span>
                    <span class="n">preds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">preds</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">cnt</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span> <span class="p">:</span> <span class="n">cnt</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>Letâ€™s test the <code class="language-plaintext highlighter-rouge">WindowedDataset</code> and ask it to plot something.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># build a test dataset based on train_df
# return 100 points for each index
# return 10 points for each target
# advance by 1
</span><span class="n">wds</span> <span class="o">=</span> <span class="n">WindowedDataset</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="s">"T (degC)"</span> <span class="p">)</span>

<span class="c1"># print the last object from the set
</span><span class="k">print</span><span class="p">(</span><span class="n">wds</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># plot the series starting at index 10
# and use only the temperature
# the feature will be plotted with continuous line
# the target with dots
</span><span class="n">wds</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">"T (degC)"</span><span class="p">)</span>
</code></pre></div></div>

<p>And the result of the plot - 100 points for the features, only the degrees Celsius (continous line) and the target, 10 points, as dots. The X-axis starts from 10 (starting index) to 120 (10 + 100 + 10).</p>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch5.jpg" alt="Plot result" /></p>

<p>We finish this part of data preparation and dataset construction by presenting the functions that construct 3 <code class="language-plaintext highlighter-rouge">Dataloader</code> objects for train, validation and test respectively. To note the <code class="language-plaintext highlighter-rouge">transform</code> lambda which transforms from <code class="language-plaintext highlighter-rouge">numpy</code> to a <code class="language-plaintext highlighter-rouge">torch.Tensor</code> of <code class="language-plaintext highlighter-rouge">float32</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_dataloader</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">input_window_len</span><span class="p">,</span> <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># make it a bit more complicated, remove the temperature completely
</span>    <span class="c1"># usually this is not needed for timeseries prediction
</span>    <span class="c1"># but more interesting to see how the models behave
</span>    <span class="n">cols</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="s">"T (degC)"</span><span class="p">)</span>
    <span class="n">cols</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="s">"Tpot (K)"</span><span class="p">)</span>
    <span class="n">cols</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="s">"Tdew (degC)"</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">WindowedDataset</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">input_window_len</span><span class="p">,</span> <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="p">[</span><span class="s">"T (degC)"</span><span class="p">],</span>  
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">target_transform</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="p">),</span> 
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> 
        <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_loaders</span><span class="p">(</span><span class="n">input_window_len</span><span class="p">,</span> <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">make_dataloader</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">input_window_len</span><span class="p">,</span> <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">valid_loader</span> <span class="o">=</span> <span class="n">make_dataloader</span><span class="p">(</span><span class="n">val_df</span><span class="p">,</span> <span class="n">input_window_len</span><span class="p">,</span> <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">make_dataloader</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">input_window_len</span><span class="p">,</span> <span class="n">target_len</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">valid_loader</span><span class="p">,</span> <span class="n">test_loader</span>
</code></pre></div></div>

<h3 id="training-loop-and-evaluating">Training loop and evaluating</h3>

<p>PyTorch uses Autograd and a pretty straightforward training loop. To note are:</p>
<ul>
  <li>Transferring the tensors to the GPU with the <code class="language-plaintext highlighter-rouge">.to(device)</code> calls.</li>
  <li>Defining a custom loss (<code class="language-plaintext highlighter-rouge">RMSELoss</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">with torch.not_grad()</code> when making predictions</li>
  <li>How backpropagation is implemented and using the optimizer</li>
  <li>Saving and loading a model</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">RMSELoss</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">mean</span><span class="p">((</span><span class="n">yhat</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">eval_</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dl</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dl</span><span class="p">):</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">y</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">RMSELoss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pred</span><span class="p">).</span><span class="n">item</span><span class="p">())</span>

            <span class="c1"># take only the first 20 batches top
</span>            <span class="k">if</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">valid_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Training loss:"</span><span class="p">,</span> <span class="n">eval_</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="n">train_ds</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Validation loss:"</span><span class="p">,</span> <span class="n">eval_</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="n">valid_ds</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Test loss:"</span><span class="p">,</span> <span class="n">eval_</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="n">test_ds</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">create_trainer</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">torch</span><span class="p">.</span><span class="n">_dynamo</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">suppress_errors</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"torch.compile() not available."</span><span class="p">)</span>

    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">model</span>
    
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">RMSELoss</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">2e-4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
        <span class="c1"># loop through the dataset and perform backpropagation"
</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">y</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Compute prediction error
</span>            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="c1"># Backpropagation
</span>            <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c1"># save losses for plotting
</span>            <span class="n">losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">batch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">loss</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">(),</span> <span class="p">(</span><span class="n">batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"loss: </span><span class="si">{</span><span class="n">loss</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">7</span><span class="n">f</span><span class="si">}</span><span class="s">  [</span><span class="si">{</span><span class="n">current</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">5</span><span class="n">d</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">size</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">5</span><span class="n">d</span><span class="si">}</span><span class="s">]"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">trainer</span><span class="p">():</span>
        <span class="c1"># load a model if already exists
</span>        <span class="c1"># else loop (epochs) times through the train function
</span>
        <span class="n">model_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">model_str</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model_str</span> <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">isalnum</span><span class="p">()])</span>
        <span class="n">model_str</span> <span class="o">=</span> <span class="n">model_str</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_str</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Epoch "</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">train</span><span class="p">()</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">model_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">trainer</span>
</code></pre></div></div>

<h3 id="basic-linear-regression">Basic Linear Regression</h3>

<p>The simplest model will take the atmospheric parameters for one hour and predicts the temperature for the next hour. Itâ€™s a basic neural network with 1 neuron and no activation, equivalent to a simple linear regression.</p>

<p>The interesting things to note are:</p>
<ul>
  <li>The structure of a neural network in PyTorch, inheriting from the <code class="language-plaintext highlighter-rouge">nn.Module</code> base class</li>
  <li>The <code class="language-plaintext highlighter-rouge">forward()</code> function which performs the forward propagation and evalution step</li>
  <li>The use of an <code class="language-plaintext highlighter-rouge">nn.Linear</code> object which is the equivalent of a Dense layer</li>
  <li>The use of <code class="language-plaintext highlighter-rouge">.to(device)</code> to ensure all parameters are submitted to the GPU</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BasicLinear</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">target_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">linear_stack</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">target_size</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">linear_stack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># one hour of data and predict the following hour
</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">make_loaders</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">BasicLinear</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">get_input_size</span><span class="p">(),</span> <span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">get_target_size</span><span class="p">()).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div></div>

<p>As a side note, if I were to build a custom linear layer, <code class="language-plaintext highlighter-rouge">CustomDense</code>, which does exactly the same thing as the <code class="language-plaintext highlighter-rouge">nn.Linear</code>, it would be as follows. Please note the use of <code class="language-plaintext highlighter-rouge">nn.Parameter()</code> to allow the system to keep track of the trainable weights.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomDense</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_in</span><span class="p">,</span> <span class="n">size_out</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>

        <span class="c1">#1. Explicit what is trainable parameters
</span>        <span class="c1"># nn.Parameter - trainable parameters
</span>        <span class="c1"># it's what we send to the constructor of the Optimizier.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">size_out</span><span class="p">,</span> <span class="n">size_in</span><span class="p">)</span>
        <span class="p">)</span>  

        <span class="bp">self</span><span class="p">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">size_out</span><span class="p">)</span>
        <span class="p">)</span> 

        <span class="c1">#2. Initialize weights and biases
</span>        <span class="c1"># He initialization
</span>        <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">kaiming_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">uniform_</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># w times x + b
</span>        <span class="n">w_times_x</span><span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">weights</span><span class="p">.</span><span class="n">t</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w_times_x</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">bias</span><span class="p">)</span>
</code></pre></div></div>

<p>Now letâ€™s use the basic network above.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># train for 5 epochs
</span><span class="n">model</span> <span class="o">=</span> <span class="n">create_trainer</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="mi">5</span><span class="p">)()</span>
<span class="nb">eval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tt</span><span class="p">)</span>

<span class="c1"># plot the temperature - actual: blue dots, predicted: organge dots
</span><span class="n">v</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">plot_prediction</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="s">"T (degC)"</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</code></pre></div></div>

<p>We observe the loss values for all sets, showing we donâ€™t overfit but also not fit too well the data.</p>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch6.jpg" alt="Plot result" /></p>

<h3 id="deep-neural-network">Deep Neural Network</h3>

<p>We are going to proceed similarly as before but add more neurons to the mix. We now send 24h of data to predict 1h in advance. The code can be changed to predict as many hours as we want in advance, buy changing only the second parameter in the <code class="language-plaintext highlighter-rouge">make_loaders(24, 1, 1)</code> call.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># deep learning, dense, given 24h of data, predict 1h in advance,
</span><span class="k">class</span> <span class="nc">DNNRegressor</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">target_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">linear_stack</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="c1">#nn.Dropout(p=0.2),
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">linear_stack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">make_loaders</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DNNRegressor</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">get_input_size</span><span class="p">(),</span> <span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">get_target_size</span><span class="p">()).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total params: "</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">))</span>
</code></pre></div></div>

<p>With the model structure and number of parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DNNRegressor(
  (linear_stack): Sequential(
    (0): Linear(in_features=384, out_features=384, bias=True)
    (1): ReLU()
    (2): Linear(in_features=384, out_features=64, bias=True)
    (3): ReLU()
    (4): Linear(in_features=64, out_features=64, bias=True)
    (5): ReLU()
    (6): Linear(in_features=64, out_features=1, bias=True)
  )
)
Total params:  176705
</code></pre></div></div>

<p>The results are as follows, and we immediately notice the lower loss while still not overfitting the dataset. Also visually, the predictions look more precise than in the linear regression case, which is expected.</p>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch7.jpg" alt="Plot result" /></p>

<h3 id="convolutional-neural-network">Convolutional Neural Network</h3>

<p>We are now going to replace one of the dense layers above with a convolutional layer. CNNs tend to have less parameters than basic DNNs due to the locality of the convolutional transform. They also tend to incorporate better local relationships in the data and extract patterns. This is why they are widely used for image processing.</p>

<p>To ensure the right data format is sent to the <code class="language-plaintext highlighter-rouge">Conv1D</code> layer, we first play a bit with arrays. Fortunately PyTorch allows immediate results, so here they are:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">)).</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">numpy</span><span class="p">())</span>
</code></pre></div></div>

<p>Outputting</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[[[1. 3. 5. 7.]
  [2. 4. 6. 8.]]

 [[1. 3. 5. 7.]
  [2. 4. 6. 8.]]

 [[1. 3. 5. 7.]
  [2. 4. 6. 8.]]]
</code></pre></div></div>

<p>This is inline with our expectation that Conv1D operation will convolve along the time dimension. With this knowledge, we build our network.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CNNRegressor</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">target_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="n">in_channels</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">seq_stack</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">AdaptiveAvgPool1d</span><span class="p">(</span><span class="n">output_size</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Flatten</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">in_channels</span><span class="p">),</span> <span class="bp">self</span><span class="p">.</span><span class="n">in_channels</span><span class="p">)).</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">seq_stack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    

<span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">make_loaders</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CNNRegressor</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">count_channels</span><span class="p">(),</span> <span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">get_target_size</span><span class="p">()).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total params: "</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CNNRegressor(
  (seq_stack): Sequential(
    (0): Conv1d(16, 256, kernel_size=(5,), stride=(1,), padding=same)
    (1): ReLU()
    (2): AdaptiveAvgPool1d(output_size=8)
    (3): Flatten(start_dim=1, end_dim=-1)
    (4): Linear(in_features=2048, out_features=64, bias=True)
    (5): ReLU()
    (6): Linear(in_features=64, out_features=64, bias=True)
    (7): ReLU()
    (8): Linear(in_features=64, out_features=1, bias=True)
  )
)
Total params:  156097
</code></pre></div></div>

<p>We immediately see the number of total parameters is smaller, even if I did no real tuning to the layer shapes, while the end results are not significantly different from the DNN. For this toy example, I did not expect much improvement.</p>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch8.jpg" alt="Plot result" /></p>

<h3 id="recurrent-neural-network">Recurrent Neural Network</h3>

<p>I will finish my post by showing the same algorithm, but this time using RNNs. I will replace all the deep layers with 4 LSTM layers. We will notice a huge decrease (3x compared to the CNN) in the number model parameters, while keeping the same performance, even a notch better. To note the way data is transmitted to the LSTM block; again we make sure the series is sent to the network along the time axis.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LSTMRegressor</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">target_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> 
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">input_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> 
            <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">batch_first</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span> <span class="c1"># number of channels
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_size</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_size</span><span class="p">)).</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ret_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">lin_input</span> <span class="o">=</span> <span class="n">ret_lstm</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># take the last output from the sequence
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">linear</span><span class="p">(</span><span class="n">lin_input</span><span class="p">)</span>
    

<span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">make_loaders</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LSTMRegressor</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">count_channels</span><span class="p">(),</span> <span class="n">target_size</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">get_target_size</span><span class="p">()).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total params: "</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LSTMRegressor(
  (lstm): LSTM(16, 32, num_layers=4, batch_first=True)
  (linear): Linear(in_features=32, out_features=1, bias=True)
)
Total params:  31777
</code></pre></div></div>

<p>The LSTM cells will memorize the most important features of th data, processing the input as a sequence passed through the network in one timestep at a time.</p>

<p>The results applying this network to the validation data, below:</p>

<p><img src="https://alexandrugris.github.io/assets/ts-pytorch9.jpg" alt="Plot result" /></p>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">From The Trenches - The Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              From The Trenches - The Code
            
            </li>
            
            <li><a href="mailto:alexandru.gris2006@gmail.com">alexandru.gris2006@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/alexandrugris"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/alexandrugris"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Alexandru Gris - Personal Blog
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
