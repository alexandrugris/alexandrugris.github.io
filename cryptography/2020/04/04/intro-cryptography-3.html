<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Introduction to Cryptography (Part 3)</title>
  <meta name="description" content="This is the third part of Introduction to Cryptography. The post covers the Java APIs that implement the same algorithms that we spoke about in the previous ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://alexandrugris.github.io/cryptography/2020/04/04/intro-cryptography-3.html">
  <link rel="alternate" type="application/rss+xml" title="From The Trenches - The Code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <div class="site-nav"><a class="site-title" href="/">From The Trenches - The Code</a> </div>

    <nav class="site-nav">
      <span class="menu-icon">        
      </span>

      <div class="trigger">

        <a class="page-link" href="https://alexandrugris.github.io">Home</a>

        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/sm/">Social Media</a>
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Introduction to Cryptography (Part 3)</h1>
    <p class="post-meta"><time datetime="2020-04-04T09:15:16+02:00" itemprop="datePublished">Apr 4, 2020</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is the third part of Introduction to Cryptography. The post covers the Java APIs that implement the same algorithms that we spoke about in the previous posts, symmetric and asymmetric encryption, as well as digital signatures. We also talk a little bit about password security and the principle behind rainbow tables.</p>

<h3 id="java-apis-encryption-decryption-signatures">Java APIs, Encryption, Decryption, Signatures</h3>

<p>I am going to exemplify here the concepts from the previous posts using the Java Cryptography Extensions (JCE). Most programming languages have similar cryptographic support. JCE revolves around the following classes:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">KeyGenerator</code> - key generator for symmetric encryption</li>
  <li><code class="language-plaintext highlighter-rouge">SecretKey</code> - the generated symmetric key</li>
  <li><code class="language-plaintext highlighter-rouge">SecureRandom</code> - cryptographically secure random number generator</li>
  <li><code class="language-plaintext highlighter-rouge">IvParameterSpec</code> - initialization vector for the algorithm (remember that the Cypher Block Chaining (CBC) requires an init vector)</li>
  <li><code class="language-plaintext highlighter-rouge">KeyPairGenerator</code> - key generator for asymmetric encryption</li>
  <li><code class="language-plaintext highlighter-rouge">PublicKey</code> - the public key</li>
  <li><code class="language-plaintext highlighter-rouge">PrivateKey</code> - the private key</li>
  <li><code class="language-plaintext highlighter-rouge">Cipher</code> - perform the work of the symmetric / asymmetric encryption</li>
  <li><code class="language-plaintext highlighter-rouge">Signature</code> - performs the work of the signature algorithm</li>
  <li><code class="language-plaintext highlighter-rouge">CipherInputStream</code> - input stream for decryption</li>
  <li><code class="language-plaintext highlighter-rouge">CipherOutputStream</code> - output stream for encryption</li>
</ul>

<p>The current Java implementation, Java 14, supports the following algorithms: <a href="https://docs.oracle.com/en/java/javase/14/docs/specs/security/standard-names.html">link</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Encrypting with symmetric encryption. Only the necessary information is shared with this method.
 * In a production scenario, these would come from a secrets database
 * @param msg - the message
 * @param algorithm - the algorithm
 * @param key - the secret key
 * @param iv - the initialization vector
 */</span>
<span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">encryptAES</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">String</span> <span class="n">algorithm</span><span class="o">,</span> <span class="nc">SecretKey</span> <span class="n">key</span><span class="o">,</span> <span class="nc">IvParameterSpec</span> <span class="n">iv</span><span class="o">)</span> 
        <span class="kd">throws</span> <span class="nc">NoSuchPaddingException</span><span class="o">,</span> 
        <span class="nc">NoSuchAlgorithmException</span><span class="o">,</span> 
        <span class="nc">InvalidAlgorithmParameterException</span><span class="o">,</span> 
        <span class="nc">InvalidKeyException</span> <span class="o">{</span>

    <span class="nc">Cipher</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="n">algorithm</span><span class="o">);</span>
    <span class="n">c</span><span class="o">.</span><span class="na">init</span> <span class="o">(</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">ENCRYPT_MODE</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">iv</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span> <span class="o">();</span>
    <span class="k">try</span><span class="o">(</span><span class="kt">var</span> <span class="n">cos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CipherOutputStream</span> <span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">c</span><span class="o">)){</span>
        <span class="n">cos</span><span class="o">.</span><span class="na">write</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span> <span class="o">());</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">exx</span><span class="o">){</span>
        <span class="n">exx</span><span class="o">.</span><span class="na">printStackTrace</span> <span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="na">toByteArray</span> <span class="o">();</span>
<span class="o">}</span>
<span class="cm">/**
 * The decryption function
 * @param encrypted - the text to be decrypted
 * @param algorithm - the algorithm used
 * @param sk - the secret key
 * @param iv - the initialization vector
 * @return
 */</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="nf">decryptAES</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">encrypted</span><span class="o">,</span> <span class="nc">String</span> <span class="n">algorithm</span><span class="o">,</span> <span class="nc">SecretKey</span> <span class="n">sk</span><span class="o">,</span> <span class="nc">IvParameterSpec</span> <span class="n">iv</span><span class="o">)</span><span class="kd">throws</span>
            <span class="nc">InvalidAlgorithmParameterException</span><span class="o">,</span> 
            <span class="nc">InvalidKeyException</span><span class="o">,</span> 
            <span class="nc">NoSuchPaddingException</span><span class="o">,</span>
            <span class="nc">NoSuchAlgorithmException</span> <span class="o">{</span>

    <span class="nc">Cipher</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="n">algorithm</span><span class="o">);</span>
    <span class="n">c</span><span class="o">.</span><span class="na">init</span> <span class="o">(</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">DECRYPT_MODE</span><span class="o">,</span> <span class="n">sk</span><span class="o">,</span> <span class="n">iv</span><span class="o">);</span>

    <span class="k">try</span><span class="o">(</span><span class="kt">var</span> <span class="n">bais</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">encrypted</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">cis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CipherInputStream</span> <span class="o">(</span><span class="n">bais</span><span class="o">,</span> <span class="n">c</span><span class="o">)){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">cis</span><span class="o">.</span><span class="na">readAllBytes</span> <span class="o">());</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span> <span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Start here
 */</span>
<span class="kd">static</span> <span class="kt">void</span> <span class="nf">test_symmetricJCE</span><span class="o">()</span> 
            <span class="kd">throws</span> <span class="nc">NoSuchAlgorithmException</span><span class="o">,</span> 
            <span class="nc">NoSuchPaddingException</span><span class="o">,</span>
            <span class="nc">InvalidAlgorithmParameterException</span><span class="o">,</span> 
            <span class="nc">InvalidKeyException</span> <span class="o">{</span>

    <span class="c1">// Generate the secret key</span>
    <span class="nc">KeyGenerator</span> <span class="n">keyGen</span> <span class="o">=</span> <span class="nc">KeyGenerator</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"AES"</span><span class="o">);</span>
    <span class="n">keyGen</span><span class="o">.</span><span class="na">init</span> <span class="o">(</span><span class="mi">256</span><span class="o">);</span>

    <span class="nc">SecretKey</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">keyGen</span><span class="o">.</span><span class="na">generateKey</span> <span class="o">();</span>
    <span class="k">assert</span> <span class="n">sk</span><span class="o">.</span><span class="na">getAlgorithm</span> <span class="o">().</span><span class="na">equals</span> <span class="o">(</span><span class="s">"AES"</span><span class="o">);</span> <span class="c1">// algorithm</span>
    <span class="k">assert</span> <span class="n">sk</span><span class="o">.</span><span class="na">getEncoded</span> <span class="o">().</span><span class="na">length</span> <span class="o">==</span> <span class="mi">32</span><span class="o">;</span> <span class="c1">// key size in bytes</span>
    
    <span class="c1">// Create an instance of the AES cypher, with CBS and</span>
    <span class="c1">// a padding to fill the missing bytes at the end of the message.</span>
    <span class="c1">// Generate the initialization vector for our CBC.</span>
    <span class="c1">// We use the block size from the algorithm for the size of our iv</span>
    <span class="nc">SecureRandom</span> <span class="n">sr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span> <span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">ivbytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"AES/CBC/PKCS5Padding"</span><span class="o">).</span><span class="na">getBlockSize</span> <span class="o">()];</span>
    <span class="n">sr</span><span class="o">.</span><span class="na">nextBytes</span> <span class="o">(</span><span class="n">ivbytes</span><span class="o">);</span>
    <span class="nc">IvParameterSpec</span> <span class="n">iv</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IvParameterSpec</span> <span class="o">(</span><span class="n">ivbytes</span><span class="o">);</span>

    <span class="c1">// encrypt and decrypt</span>
    <span class="kt">var</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"This is my first long message encrypted with AES / CBC"</span><span class="o">;</span>
    <span class="kt">var</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">encryptAES</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">"AES/CBC/PKCS5Padding"</span><span class="o">,</span> <span class="n">sk</span><span class="o">,</span> <span class="n">iv</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">decryptAES</span><span class="o">(</span><span class="n">encrypted</span><span class="o">,</span> <span class="s">"AES/CBC/PKCS5Padding"</span><span class="o">,</span> <span class="n">sk</span><span class="o">,</span> <span class="n">iv</span><span class="o">);</span>
    
    <span class="k">assert</span> <span class="n">msg</span><span class="o">.</span><span class="na">equals</span> <span class="o">(</span><span class="n">decrypted</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the picture below we can observe that the secret key is just an array of bytes, similar to what we have seen when we implemented the algorithm from scratch, in the previous post.</p>

<p><img src="https://alexandrugris.github.io/assets/crypto3_2.png" alt="Secret Key" /></p>

<p>It is important to note that, if two messages start with the same bytes, the first bytes in the encrypted string for both of them will be the same, if we use the same initialization vector. Therefore, it is good practice to change the initialization vector with each message.</p>

<p>For the asymmetric encryption, the process is very similar. The only differences are in the methods we call on the <code class="language-plaintext highlighter-rouge">Cipher</code> class. Since <code class="language-plaintext highlighter-rouge">Cipher</code> works iteratively on blocks, to encrypt / decrypt with <code class="language-plaintext highlighter-rouge">RSA</code> which is not a block cipher, we need to invoke <code class="language-plaintext highlighter-rouge">Cipher::doFinal()</code> on the cipher, as if the whole message is a single block. Example below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test_asymmetricJCE</span><span class="o">()</span> <span class="kd">throws</span> 
        <span class="nc">NoSuchAlgorithmException</span><span class="o">,</span> 
        <span class="nc">NoSuchPaddingException</span><span class="o">,</span>
        <span class="nc">InvalidKeyException</span><span class="o">,</span> 
        <span class="nc">BadPaddingException</span><span class="o">,</span> 
        <span class="nc">IllegalBlockSizeException</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"This is my first long message encrypted with RSA"</span><span class="o">;</span>
    <span class="nc">KeyPairGenerator</span> <span class="n">kg</span> <span class="o">=</span> <span class="nc">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"RSA"</span><span class="o">);</span>
    <span class="n">kg</span><span class="o">.</span><span class="na">initialize</span> <span class="o">(</span><span class="mi">2048</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kg</span><span class="o">.</span><span class="na">generateKeyPair</span> <span class="o">();</span>

    <span class="c1">// encrypt</span>
    <span class="kt">var</span> <span class="n">c1</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"RSA/ECB/PKCS1Padding"</span><span class="o">);</span>
    <span class="n">c1</span><span class="o">.</span><span class="na">init</span> <span class="o">(</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">ENCRYPT_MODE</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span> <span class="o">());</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">encrypt</span> <span class="o">=</span>  <span class="n">c1</span><span class="o">.</span><span class="na">doFinal</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span> <span class="o">());</span>

    <span class="c1">// decrypt</span>
    <span class="kt">var</span> <span class="n">c2</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"RSA/ECB/PKCS1Padding"</span><span class="o">);</span>
    <span class="n">c2</span><span class="o">.</span><span class="na">init</span> <span class="o">(</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">DECRYPT_MODE</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPublic</span> <span class="o">());</span>
    <span class="kt">var</span> <span class="n">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="na">doFinal</span> <span class="o">(</span><span class="n">encrypt</span><span class="o">));</span>
    <span class="k">assert</span> <span class="n">ret</span><span class="o">.</span><span class="na">equals</span> <span class="o">(</span><span class="n">msg</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the picture below we can see the public / private key pair expanded. We observe the same elements that we spoke about when we implemented the algorithm from scratch, in the previous post:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">p</code> and <code class="language-plaintext highlighter-rouge">q</code> my private two large prime numbers</li>
  <li><code class="language-plaintext highlighter-rouge">n = p*q</code>, the modulo, shared</li>
  <li><code class="language-plaintext highlighter-rouge">e</code>, the public exponent - shared (encrypting) - the requirement for this is to be relatively prime to <code class="language-plaintext highlighter-rouge">p-1</code> and <code class="language-plaintext highlighter-rouge">q-1</code>. A commonly used exponent is <code class="language-plaintext highlighter-rouge">65537</code> since it is a prime number all together .</li>
  <li><code class="language-plaintext highlighter-rouge">d</code>, the private exponent - shared (decrypting) -</li>
</ul>

<p><img src="https://alexandrugris.github.io/assets/crypto3_3.png" alt="Public / Private Key Pair" /></p>

<p><em>Several important notes:</em></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">KeyPairGenerator::generateKeyPair()</code> might take several seconds. Therefore, it is better to store / read the keys from a secure key store.</p>
  </li>
  <li>
    <p>The RSA algorithm is generally slow so, in practice, it is used to <code class="language-plaintext highlighter-rouge">encrypt -&gt; transmit -&gt; decrypt</code> a key that will be used further with a symmetric encryption algorithm. In our case, we would have had encrypted the <code class="language-plaintext highlighter-rouge">SecretKey</code> from the first example, transmit it over the wire, then use that <code class="language-plaintext highlighter-rouge">SecretKey</code> to encrypt the rest of the communication.</p>
  </li>
</ul>

<p>Now, let’s use the private / public key pair to sign a message:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test_signaturesJCE</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">NoSuchAlgorithmException</span><span class="o">,</span> <span class="nc">InvalidKeyException</span><span class="o">,</span> <span class="nc">SignatureException</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"This is my first long message signed with RSA"</span><span class="o">;</span>

    <span class="nc">KeyPairGenerator</span> <span class="n">kg</span> <span class="o">=</span> <span class="nc">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"RSA"</span><span class="o">);</span>
    <span class="n">kg</span><span class="o">.</span><span class="na">initialize</span> <span class="o">(</span><span class="mi">2048</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kg</span><span class="o">.</span><span class="na">generateKeyPair</span> <span class="o">();</span>

    <span class="c1">// sign</span>
    <span class="kt">var</span> <span class="n">sigSign</span> <span class="o">=</span> <span class="nc">Signature</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"SHA256withRSA"</span><span class="o">);</span>
    <span class="n">sigSign</span><span class="o">.</span><span class="na">initSign</span> <span class="o">(</span><span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span> <span class="o">());</span>
    <span class="n">sigSign</span><span class="o">.</span><span class="na">update</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span> <span class="o">());</span>
    <span class="kt">var</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">sigSign</span><span class="o">.</span><span class="na">sign</span> <span class="o">();</span>

    <span class="c1">// verify</span>
    <span class="kt">var</span> <span class="n">sigVerify</span> <span class="o">=</span> <span class="nc">Signature</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"SHA256withRSA"</span><span class="o">);</span>
    <span class="n">sigVerify</span><span class="o">.</span><span class="na">initVerify</span> <span class="o">(</span><span class="n">kp</span><span class="o">.</span><span class="na">getPublic</span> <span class="o">());</span>
    <span class="n">sigVerify</span><span class="o">.</span><span class="na">update</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span> <span class="o">());</span>
    <span class="kt">var</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sigVerify</span><span class="o">.</span><span class="na">verify</span> <span class="o">(</span><span class="n">sig</span><span class="o">);</span>

    <span class="k">assert</span> <span class="n">ret</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="authentication-and-authorization">Authentication and Authorization</h3>

<p>The first thing to know about passwords is that you never store them in clear text. More precisely you don’t even need to store the full password in any form. Since the verification is just one way, it is enough to store a password hash that is checked against every time the password is entered. The most basic form for checking whether a site keeps passwords in clear text is so see if they offer a password retrieval function. If they do, better close the account and never use that password again.</p>

<p>A more common form of attack are leaked password hashes. We could use dictionary attacks to match hashes to known passwords and that would lead to dictionaries being extremely large. A method that trades the size of the dictionary for a bit of additional computation is the rainbow table. The principle is to compute a series of chains, pairs of <code class="language-plaintext highlighter-rouge">(starting password, ending hash)</code>. Each chain is, in fact, like (starting password -&gt; hash -&gt; new password -&gt; hash … -&gt; ending hash), but, since we know the transform function from password to hash and then from hash to a new potential password, we don’t need to store the intermediate results. We don’t want to reverse the hash, but to try to find a collision. What is needed for rainbow table to work are (a) a leaked the password hash and (b) the algorithm used for obtaining that hash. The algorithm starts by identifying which chain the leaked hash belongs to and then, iterating through the chain, find a password that generates that very same hash.</p>

<p>Here is a very basic example of the principle, written in Java. The code is based on this <a href="https://www.ionos.com/digitalguide/server/security/rainbow-tables/">excellent article</a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">ro.alexandrugris</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="c1">// compute password -&gt; hash -&gt; password chain</span>
    <span class="c1">// for simplicity, in our case, hash -&gt; password function is just the identity function</span>
    <span class="kd">static</span> <span class="nc">String</span> <span class="nf">hash</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">){</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">str</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">toUpperCase</span> <span class="o">().</span><span class="na">getBytes</span> <span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">US_ASCII</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">n_pass</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>

        <span class="c1">// a very basic and a very bad hash function</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="kt">var</span> <span class="n">x</span> <span class="o">=</span> <span class="n">str</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">-</span> <span class="sc">'A'</span><span class="o">;</span>
            <span class="kt">var</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="mi">2000</span> <span class="o">*</span> <span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1.618</span> <span class="o">%</span> <span class="mi">1</span><span class="o">));</span>
            <span class="n">n_pass</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)(</span><span class="n">hash</span> <span class="o">%</span> <span class="o">(</span><span class="sc">'A'</span> <span class="o">-</span> <span class="sc">'Z'</span><span class="o">)</span> <span class="o">+</span> <span class="sc">'A'</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span> <span class="o">(</span><span class="n">n_pass</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="nc">String</span> <span class="nf">computeChain</span><span class="o">(</span><span class="nc">String</span> <span class="n">start</span><span class="o">){</span>

        <span class="c1">// chains of 4, because our hash function is very weak and it loops very quickly.</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">(</span><span class="n">start</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">start</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="nc">String</span> <span class="nf">guessPassword</span><span class="o">(</span><span class="nc">String</span> <span class="n">initial</span><span class="o">,</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">){</span>

        <span class="nc">String</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">initial</span><span class="o">;</span>

        <span class="c1">// N = 100 tries</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
            <span class="c1">// 3. try to find the hash in the rainbow table</span>
            <span class="kt">var</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span> <span class="o">(</span><span class="n">hash</span><span class="o">);</span>

            <span class="c1">// 4. if the hash was not found, compute the next password and the next hash</span>
            <span class="k">if</span><span class="o">(</span><span class="n">chain</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">hash</span> <span class="o">=</span> <span class="n">computeChain</span> <span class="o">(</span><span class="n">hash</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span><span class="o">{</span>
                <span class="c1">// 5. the hash was found, which means I found the chain</span>
                <span class="c1">// start from the beginning of the chain,</span>
                <span class="c1">// compute the hash.</span>
                <span class="c1">// When the hash is equal to the hash I want to break,</span>
                <span class="c1">// that is a working password!</span>
                <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                    <span class="kt">var</span> <span class="n">next</span> <span class="o">=</span> <span class="n">computeChain</span> <span class="o">(</span><span class="n">chain</span><span class="o">);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">equals</span> <span class="o">(</span><span class="n">initial</span><span class="o">))</span>
                        <span class="k">return</span> <span class="n">chain</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">chain</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// not found</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// 1. compute rainbow table, a hashmap of &lt;hash, starting point&gt;</span>
        <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">myRainbowTable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;</span> <span class="o">();</span>

        <span class="nc">String</span><span class="o">[]</span> <span class="n">startingPoints</span> <span class="o">=</span> <span class="o">{</span>
                <span class="s">"HELL"</span><span class="o">,</span>
                <span class="s">"BUBU"</span><span class="o">,</span>
                <span class="s">"FUFU"</span><span class="o">,</span>
                <span class="s">"ROCK"</span>
        <span class="o">};</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">s</span> <span class="o">:</span> <span class="n">startingPoints</span><span class="o">){</span>
            <span class="n">myRainbowTable</span><span class="o">.</span><span class="na">put</span> <span class="o">(</span><span class="n">computeChain</span> <span class="o">(</span><span class="n">s</span><span class="o">),</span> <span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 2. obtain the password hash we want to reverse</span>
        <span class="kt">var</span> <span class="n">passHash</span> <span class="o">=</span> <span class="s">"WJGG"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">guessPassword</span><span class="o">(</span><span class="n">passHash</span><span class="o">,</span> <span class="n">myRainbowTable</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The interesting thing to observe is how an increased password complexity increases exponentially the complexity of generating and searching the rainbow table. It also shows that for salted passwords an attacker will have a harder time reversing it as it has to start by generating the rainbow table for those specific salts. The salt itself, a string pre-pended or appended to the password, does not need to be protected. It can be stored in plain text in the passwords table, but, for good protection, it should different for every user.</p>

<p>To make it unfeasible for an attacker to brute force our passwords, the algorithm used to compute the hash should be (a) irreversible (b) take a long time. The application only runs this algorithm for each login, but the attacker would have to run it for every password retry. The recommended approach is called <a href="https://en.wikipedia.org/wiki/PBKDF2"><code class="language-plaintext highlighter-rouge">PBKDF</code></a> and the general concept is called <em>key stretching</em>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="nc">String</span> <span class="nf">passwordHash</span><span class="o">(</span><span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="nc">String</span> <span class="n">salt</span><span class="o">,</span> <span class="kt">int</span> <span class="n">iterations</span><span class="o">,</span> <span class="kt">int</span> <span class="n">keyLength</span><span class="o">)</span> 
    <span class="kd">throws</span> <span class="nc">NoSuchAlgorithmException</span><span class="o">,</span> <span class="nc">InvalidKeySpecException</span> <span class="o">{</span>

    <span class="nc">SecretKeyFactory</span> <span class="n">f</span> <span class="o">=</span> <span class="nc">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span> <span class="o">(</span><span class="s">"PBKDF2WithHmacSHA1"</span><span class="o">);</span>
    
    <span class="c1">// iterations should be minimum 1000, preferably 10000</span>
    <span class="c1">// should be increased as computers become more powerful</span>
    <span class="c1">// the idea is to have a time-consuming operation </span>
    <span class="c1">// that makes it computationally hard for the attacker to brute force the password</span>
    <span class="nc">KeySpec</span> <span class="n">ks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PBEKeySpec</span> <span class="o">(</span><span class="n">password</span><span class="o">.</span><span class="na">toCharArray</span> <span class="o">(),</span> <span class="n">salt</span><span class="o">.</span><span class="na">getBytes</span> <span class="o">(),</span> <span class="n">iterations</span><span class="o">,</span> <span class="n">keyLength</span><span class="o">);</span>
    <span class="nc">SecretKey</span> <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">generateSecret</span> <span class="o">(</span><span class="n">ks</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="nc">Base64</span><span class="o">.</span><span class="na">getEncoder</span> <span class="o">().</span><span class="na">encode</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getEncoded</span> <span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">From The Trenches - The Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              From The Trenches - The Code
            
            </li>
            
            <li><a href="mailto:alexandru.gris2006@gmail.com">alexandru.gris2006@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/alexandrugris"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/alexandrugris"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Alexandru Gris - Personal Blog
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
