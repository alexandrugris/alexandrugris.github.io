<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Risk-based Odds Adjustment Using Bayesian Inference</title>
  <meta name="description" content="This blog introduces the basics of Bayesian inference and attempts to sketch a solution to a problem a bookmaker might have: starting from a predefined set o...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://alexandrugris.github.io/statistics/2017/10/29/odds-adjustment-risk.html">
  <link rel="alternate" type="application/rss+xml" title="From The Trenches - The Code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <div class="site-nav"><a class="site-title" href="/">From The Trenches - The Code</a> </div>

    <nav class="site-nav">
      <span class="menu-icon">        
      </span>

      <div class="trigger">

        <a class="page-link" href="https://alexandrugris.github.io">Home</a>

        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/sm/">Social Media</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Risk-based Odds Adjustment Using Bayesian Inference</h1>
    <p class="post-meta"><time datetime="2017-10-29T13:15:16+02:00" itemprop="datePublished">Oct 29, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This blog introduces the basics of Bayesian inference and attempts to sketch a solution to a problem a bookmaker might have: starting from a predefined set of odds, how do we adjust them so that the risk to the bookmaker is minimized, by taking into consideration the financial stakes the bettors have placed on a game. We will only look at a 1x2 market (home-draw-away) to keep the code clean.</p>

<h3 id="bayesian-inference-basics">Bayesian Inference basics</h3>

<p>In simple terms, Bayesian Inference tries to solve problems which revolve around the following pattern: “given our belief of the world at a certain point of time, if new evidence becomes available, how do these affect our beliefs”? Or, put differenly, “given a model of the world with a set of a priori parameters, if new evidence becomes available, how will the parameters change to incorporate this new evidence?”</p>

<p><em>Examples of problems that can be solved through Bayesian Inference</em></p>

<ul>
  <li>
    <p>One might believe a coin is slightly biased with and heads will turn with a probability PH while tails will turn with a probability PT. By starting a set of trial,
 one can adjust the PH and PT according to the results of each trial, having the model migrate towards the real probabilities.</p>
  </li>
  <li>
    <p>Evaluating the success of a marketing campaign, by counting the clicks on a set of ads, so that the most successful ad is presented to the customer. In such a case, we can start with a “all the same” approach and then adjust display probabilities according to click data that comes through in real time and with minimum computational overhead.</p>
  </li>
  <li>
    <p>Given a number of clicks or misses on an add, what is the probability of the next user to click on it?</p>
  </li>
  <li>
    <p>Archaeological dating based on the types of objects found on the site <a href="https://en.wikipedia.org/wiki/Bayesian_inference#Making_a_prediction">wikipedia</a></p>
  </li>
</ul>

<p><em>Bayes’ Theorem</em></p>

<p>Vocabulary:</p>

<ul>
  <li>Posterior probability <code class="highlighter-rouge">P(hypothesis | evidence)</code>: what we want to know, the probability of a hypothesis given the observed evidence.</li>
  <li>Prior probability <code class="highlighter-rouge">P(hypothesis)</code>: the estimate of the probability before the evidence appears</li>
  <li>Probability of observing the evidence given the hypothesis <code class="highlighter-rouge">P(evidence | hypothesis)</code></li>
  <li>Probability of the event to happen: <code class="highlighter-rouge">P(E)</code></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>P(H | E) = P(E | H) * P(H) / P(E)
</code></pre>
</div>

<p><em>Worked examples:</em></p>

<ol>
  <li>Given that a medical test offers 99% accuracy in detecting a desease and given that the desease appears in 1 in 100 individuals, if you score positive on the test, what is the probability of you actually having the disease?</li>
</ol>

<p>90% accuracy means that 99% of the people tested and have the disease test positive, while 1% of the people that don’t have the disease also test positive. We also consider the opposite to be true: if the test gives a negative result, 99% probability you don’t have the disease.</p>

<ul>
  <li><code class="highlighter-rouge">P(have the disease given if you scored positive on the test) = P(hypothesis | evidence)</code></li>
  <li><code class="highlighter-rouge">P(you have the disease from the whole population) = P(hypothesis) = 1/100</code></li>
  <li><code class="highlighter-rouge">P(scored positive on the test if you had the disease) = P(evidence | hypothesis) = 99/100</code></li>
  <li><code class="highlighter-rouge">P(event) = P(scored positive on the test) = P(have the disease and scored positive) + P(don't have the disease and scored positive) = (99/100) * (1/100) + (1/100) * (99/100)</code></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>P(H|E) = (P(E|H) * P(H)) / P(E)
P(H|E) = ((99/100) * (1/100)) / ((99/100) * (1/100) + (1/100) * (99/100) = 1/2 = 50%
</code></pre>
</div>

<ol>
  <li>A family has two children. The first born is a boy. What is the probability that the second one is a boy?</li>
</ol>

<p>Obviously, two independent events, the answer is <code class="highlighter-rouge">1/2</code>.</p>

<ol>
  <li>A family has two children. One of them is a boy. What is the probability that the family has two boys?</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>P(the family has two boys | one of them is a boy) = 
    P(if a family has two boys, the probabiliy that one of them is a boy) * P(a family has two boys) / 
    P(at least one of the children is a boy in a family with two children)

P(H|E) = (1 * 1/4) / (1 - P(both children are girls)) = (1/4) / (3/4) = 1/3
</code></pre>
</div>

<p><em>Beta Distribution and Bayesian Inference</em></p>

<p>In Bayesian inference, the beta distribution is the conjugate prior probability distribution for the Bernoulli, binomial, negative binomial and Geometric distribution <a href="https://en.wikipedia.org/wiki/Beta_distribution">Wikipedia</a>.
This means that, given our initial knowledge of a system, as new events come, we can adjust our knowledge by simply updating the beta distribution parameters.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">B</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">beta_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">B</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">/</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">beta_pdf_array</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="n">x_</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="n">beta_pdf</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">count</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_</span><span class="p">]</span>
</code></pre>
</div>

<p>Here are some charts for various parameters of <code class="highlighter-rouge">alpha</code> and <code class="highlighter-rouge">beta</code>:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">beta_pdf_array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">beta_pdf_array</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">)</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">beta_pdf_array</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"magenta"</span><span class="p">)</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">beta_pdf_array</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"green"</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="https://alexandrugris.github.io/assets/bayes_1.png" alt="Beta Distribution" /></p>

<p>The larger alpha and beta are, the narrower the distribution is. For example, if alpha and beta are both 1, it’s just the uniform distribution (centered at 0.5, very dispersed). 
If alpha is much larger than beta, most of the weight is near 1.</p>

<p>So let’s say we assume a coin toss experiment, with a probability of <code class="highlighter-rouge">p</code> for heads to appear. If we don’t want to take a stand on whether the coin is fair, we choose alpha and beta to both equal 1. Or maybe we have a strong belief that it lands heads 55% of the time, and we choose alpha equals 55, beta equals 45. The higher the numbers for alpha and beta are, the tighter the distribution is and a stronger belief we express. 
When we flip our coin a several times and see <code class="highlighter-rouge">h</code> heads and <code class="highlighter-rouge">t</code> tails, Bayes’s theorem and additional mathemathics tell us that the posterior distribution for <code class="highlighter-rouge">p</code> is again a Beta distribution, with adjusted parameters <code class="highlighter-rouge">alpha + h</code> and <code class="highlighter-rouge">beta + t</code>. We will use this result when we will compute the odds adjustments later in this post, based on the possible returns of a series of bets.</p>

<h3 id="sports-betting-vocabulary">Sports Betting Vocabulary</h3>

<ul>
  <li>Odds in the European format (the one we use further in the article): odds of 3 means that if we place a 100 EUR bet on an outcome and that outcome materializes, we receive back 300 EUR.</li>
  <li>Market: where you place a bet on specific outcomes. Popular betting markets include winner (home, draw, away), over/under, Asian handicaps, correct score, first goalscorer, half-time result and many more.</li>
  <li>Payout: how much of the total stakes are returned back to players</li>
  <li>Probability of an outcome to happen, assuming 0 payout, is 1/odds</li>
</ul>

<p>Below is some sports-specific code used later in the article:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">payout</span><span class="p">(</span><span class="n">odds</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">([</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">odds</span><span class="p">])</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">normalize_odds</span><span class="p">(</span><span class="n">odds</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">payout</span><span class="p">(</span><span class="n">odds</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">o</span> <span class="o">*</span> <span class="n">norm</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">odds</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">probabilities_from_normalzed_odds</span><span class="p">(</span><span class="n">odds</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">odds</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">prob_1x2</span><span class="p">(</span><span class="n">_home_odds</span><span class="p">,</span> <span class="n">_draw_odds</span><span class="p">,</span> <span class="n">_away_odds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">norm_odds</span> <span class="o">=</span> <span class="n">normalize_odds</span><span class="p">([</span><span class="n">_home_odds</span><span class="p">,</span> <span class="n">_draw_odds</span><span class="p">,</span> <span class="n">_away_odds</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">probabilities_from_normalzed_odds</span><span class="p">(</span><span class="n">norm_odds</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">probabilities_to_odds</span><span class="p">(</span><span class="n">normalized_probability</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">set_payout</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">set_payout</span> <span class="o">/</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">normalized_probability</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">lst_of_probabilities</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lst_of_probabilities</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lst_of_probabilities</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">r</span>
</code></pre>
</div>

<p>For instance:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">home_odds</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="n">draw_odds</span> <span class="o">=</span> <span class="mf">3.5</span>
<span class="n">away_odds</span> <span class="o">=</span> <span class="mf">2.8</span>
<span class="n">set_payout</span> <span class="o">=</span> <span class="n">payout</span><span class="p">([</span><span class="n">home_odds</span><span class="p">,</span> <span class="n">draw_odds</span><span class="p">,</span> <span class="n">away_odds</span><span class="p">])</span>
</code></pre>
</div>

<p>We get a payout of around <code class="highlighter-rouge">95%</code></p>

<h3 id="the-code-and-explanations">The code and explanations</h3>

<p>Please read the code. Much of the explanation for how this works is directly embedded in comments.</p>

<p>To keep the results understandable, I used a test bed composed of 3 types of bet placing strategies:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">place_bet_random</span><span class="p">():</span>
    <span class="s">"""Places a random bet, with probabilities of placing the bet for each outcome 
    hardcoded in the first line of the function"""</span>
    <span class="n">bet_probabilities</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">money</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">bet</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c"># bet according to probabilities above</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">bet_probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="n">money</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">bet_probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bet_probabilities</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">money</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">place_bet_max_stake</span><span class="p">():</span>
    <span class="s">"""Places a bet on the highest stake"""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">money</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">bet</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">odds_evolution</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">odds_evolution</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bet</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">money</span>
        <span class="k">yield</span> <span class="n">bet</span>


<span class="k">def</span> <span class="nf">place_bet_diverse</span><span class="p">():</span>
    <span class="s">""" A combination of the strategies above, with a probability of 1/3 to place bet on the max stake"""</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">place_bet_max_stake</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">place_bet_random</span><span class="p">()</span>
</code></pre>
</div>

<p>To run the tests, we considered several initial odds, with a high payout, so that we emulate a real operator risk management as closely as possible and checked if we go bankrupt and how much money do we make.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">total_market_risk</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c"># monetary units; how much we are willing to lose, as the house.</span>

<span class="n">home_odds</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="n">draw_odds</span> <span class="o">=</span> <span class="mf">3.5</span>
<span class="n">away_odds</span> <span class="o">=</span> <span class="mf">2.8</span>

<span class="n">confidence_factor</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># a factor used later to enhance our belief in our odds. </span>

<span class="c"># 1 =&gt; our belief in odds are reflected by the monetary stake we are willing to put forward as risk</span>
<span class="c">#&lt;1 =&gt; we will let the market decide, leading to higher initial fluctuations in odds as bets accumulate</span>
<span class="c">#&gt;1 =&gt; we strongly believe we have good odds; lower variations in the beginning for the odds</span>

<span class="n">set_payout</span> <span class="o">=</span> <span class="n">payout</span><span class="p">([</span><span class="n">home_odds</span><span class="p">,</span> <span class="n">draw_odds</span><span class="p">,</span> <span class="n">away_odds</span><span class="p">])</span>
<span class="n">initial_probabilities</span> <span class="o">=</span> <span class="n">prob_1x2</span><span class="p">(</span><span class="n">home_odds</span><span class="p">,</span> <span class="n">draw_odds</span><span class="p">,</span> <span class="n">away_odds</span><span class="p">)</span>

<span class="c"># simulation</span>
<span class="n">payments_per_outcome</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">initial_probabilities</span>

<span class="c"># our initial alpha and beta probabilities </span>
<span class="c"># in short, for each outcome (1, x, 2) we assign a beta distribution of probabilities for that outcome to occur</span>
<span class="c"># just like the coin: p of winning and 1-p of losing, weighted by the confidence_factor * total_market_risk</span>
<span class="n">alpha_beta</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span> <span class="o">*</span> <span class="n">confidence_factor</span><span class="p">,</span> <span class="n">confidence_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_market_risk</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>
              <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">total_market_risk</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">initial_probabilities</span><span class="p">]]</span>

<span class="c"># an array we use forward to save the odds in order to chart the graphs</span>
<span class="n">odds_evolution</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre>
</div>

<p>The code for the simulation is pretty straight forward:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">accept_bet_risk</span><span class="p">(</span><span class="n">bet</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">):</span>
    <span class="s">""" Accepts / rejects the bet, while updating the financial risk for the market. 

    The risk computation is simple:
        - We have X buckets for X mutually exclusive outcomes - (for 1x2, 3 buckets: home-draw-away)
        - We add the payments to be made in case of winning the bet to the right bucket. payment = odds x stake
        - We compute the exposure by substracting from the maximum bucket the sum of the other two.
        - If the exposure is higher than the maximum market exposure, we don't acccept the bet"""</span>

    <span class="k">global</span> <span class="n">payments_per_outcome</span>
    <span class="k">global</span> <span class="n">alpha_beta</span>

    <span class="k">assert</span> <span class="p">(</span><span class="mf">0.999</span> <span class="o">&lt;</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.001</span><span class="p">)</span>

    <span class="n">payment_per_bet</span> <span class="o">=</span> <span class="p">[</span><span class="n">pto</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">pto</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">probabilities_to_odds</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">set_payout</span><span class="p">),</span> <span class="n">bet</span><span class="p">)]</span>
    <span class="n">total_payment_per_outcome</span> <span class="o">=</span> <span class="p">[</span><span class="n">ppo</span> <span class="o">+</span> <span class="n">ppb</span> <span class="k">for</span> <span class="n">ppo</span><span class="p">,</span> <span class="n">ppb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">payments_per_outcome</span><span class="p">,</span> <span class="n">payment_per_bet</span><span class="p">)]</span>

    <span class="c"># because we talk about mutually exclusive events:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">total_payment_per_outcome</span><span class="p">)</span>
    <span class="n">exposure</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ppo</span> <span class="o">-</span> <span class="n">s</span> <span class="k">for</span> <span class="n">ppo</span> <span class="ow">in</span> <span class="n">total_payment_per_outcome</span><span class="p">])</span>

    <span class="c"># somehow contradictory: while we do not accept the bet if the exposure is too high,</span>
    <span class="c"># we do allow the bet to shift the odds -&gt; can be a trigger for fraud, so additional care</span>
    <span class="c"># should be taken in a real-life implementation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">&gt;</span> <span class="n">total_market_risk</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Bet Not Accepted"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bet</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">payment_per_bet</span>  <span class="c"># do not update the payments</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"ooops, we are in minus"</span><span class="p">)</span>

    <span class="n">payments_per_outcome</span> <span class="o">=</span> <span class="n">total_payment_per_outcome</span>
    <span class="k">return</span> <span class="n">payment_per_bet</span>


<span class="c"># main service</span>
<span class="n">odds_evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probabilities_to_odds</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">set_payout</span><span class="p">))</span>
<span class="k">for</span> <span class="n">bet</span> <span class="ow">in</span> <span class="n">place_bet_random</span><span class="p">():</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">accept_bet_risk</span><span class="p">(</span><span class="n">bet</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>

    <span class="c"># updates alpha and beta for each possible outcome using the financial information</span>
    <span class="c"># like binomial (coin-toss), alpha + r, beta + max(returns) - r</span>
    <span class="c"># where returns = odds * stake (a list of 3 in case of 1x2) and </span>
    <span class="c"># r is the return on the specific outcome (can be 0 or max(returns))</span>
    <span class="c"># basically each EUR won is transformed in a "heads" event, the max(returns) = the sum of tosses</span>
    <span class="n">alpha_beta</span> <span class="o">=</span> <span class="p">[(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">beta</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">),</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alpha_beta</span><span class="p">,</span> <span class="n">returns</span><span class="p">)]</span>

    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">([</span><span class="n">center</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="k">for</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">alpha_beta</span><span class="p">])</span>
    <span class="n">odds_evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probabilities_to_odds</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">set_payout</span><span class="p">))</span>

</code></pre>
</div>

<p>The results are then displayed as a chart, like this:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Total exposure: "</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">payments_per_outcome</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ppo</span> <span class="o">-</span> <span class="n">s</span> <span class="k">for</span> <span class="n">ppo</span> <span class="ow">in</span> <span class="n">payments_per_outcome</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>

<span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">odds_evolution</span><span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">odds_evolution</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">odds_evolution</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)),</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)),</span> <span class="n">d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)),</span> <span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"green"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<h3 id="the-results">The results</h3>

<p><img src="https://alexandrugris.github.io/assets/bayes_2.png" alt="Results" /></p>

<p><em>The scenario above:</em></p>
<ul>
  <li>We start with an offering of <code class="highlighter-rouge">[2.5, 3.5, 2.8]</code></li>
  <li>We place 1000 bets</li>
  <li>We place bet with a preference for the first outcome, according to <code class="highlighter-rouge">normalize([0.5, 0.3, 0.3])</code> (like, for instance, would happen in Bucharest if Steaua plays at home)</li>
  <li>One third of the players aim just for the highest odds, playing just for money.</li>
  <li>We place bets between 0 and 100 EURs</li>
</ul>

<p><em>How to interpret the results:</em></p>
<ul>
  <li>Because the inital risk was just 1000 EUR and we kept the <code class="highlighter-rouge">confidence_factor=1</code>, we see some significant odds variations in the beginning (attention to markets where only just a few bets are placed, e.g. Afganistan second division)</li>
  <li>After the initial chaos, the odds stabilize. Due to our preference for the first market, the odds there are lower there and, due to the fact that we have also a preference for the highest payout, the odds for the other two markets are roughly equal.</li>
  <li>Despite the high payout (95%), our exposure is <code class="highlighter-rouge">-30536</code>, meaning that, no matter what the end result is, the house wins at least <code class="highlighter-rouge">-30536</code> from <code class="highlighter-rouge">1000</code> bets.</li>
  <li>We are sometimes in the minus, meaning that the house might lose money on this market if there are not enough bets.</li>
</ul>

<p>If we run several simulations we notice that, unless the initial offering is completely off-mark and the number of bets are is small, the house wins nice money in most of the cases. The results are consistent.</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">From The Trenches - The Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              From The Trenches - The Code
            
            </li>
            
            <li><a href="mailto:alexandru.gris2006@gmail.com">alexandru.gris2006@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/alexandrugris"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/alexandrugris"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">alexandrugris</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Alexandru Gris - Personal Blog
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
